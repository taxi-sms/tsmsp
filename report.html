<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
      content="width=device-width,
               initial-scale=1,
               maximum-scale=1,
               user-scalable=no"/>
  <title>日報入力（Excel四角版）</title>
    <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
<style>
    :root{ --bg:#fff; --text:#111; --muted:#666; --border:#999; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:"Noto Sans JP", sans-serif;
      font-size:18px;
    }
    .main{padding:8px 12px 12px;}
    .note{font-size:13px;color:var(--muted);line-height:1.35;margin:8px 0;}
    main .wf-panel{
      border:0;
      background:transparent !important;
      margin:8px 0;
      padding:6px 0 2px;
    }
    .wf-label{
      display:flex;align-items:center;gap:10px;
      font-weight:800;font-size:16px;margin:0 0 8px 0;
      text-align:left;
    }
    .wf-label::after{
      content:"";
      flex:1 1 auto;
      border-top:2px solid var(--border);
      opacity:.95;
    }
    .wf-subnote{font-size:12px;color:var(--muted);margin:-2px 0 8px 0;}
    .wf-row{display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;}
    .btn{appearance:none;-webkit-appearance:none;border:2px solid var(--border);background:#fff;
      border-radius:0;padding:14px 8px;font-size:16px;min-height:56px;
    }
    .btn.is-selected{border:2px solid #1A7A28;background:#1F9A33!important;color:#fff!important;}
#btn_discount.is-selected,
#btn_discount.is-selected:hover,
#btn_discount.is-selected:active,
#btn_discount.is-selected:focus-visible{
  border:2px solid #1A7A28!important;
  background:#1F9A33!important;
  color:#fff!important;
}
    .wf-form{display:grid;gap:10px;}
    .wf-field{display:grid;gap:6px;}
    .wf-field-label{font-size:13px;color:var(--muted);}
    .input{width:100%;box-sizing:border-box;border:2px solid var(--border);border-radius:0;
      padding:14px 10px;font-size:20px;min-height:56px;background:#fff;
    }
    .wf-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px;}
    .wf-inline{display:grid;grid-template-columns:7fr 3fr;gap:8px;align-items:end;}
    .is-hidden{display:none !important;}
    .keypad{margin-top:0;border-top:0;padding-top:0;}
    .keypad-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;}
    .key{border:2px solid var(--border);border-radius:0;background:#fff;min-height:60px;font-size:22px;}
    .key.small{font-size:16px;}
    @media (max-width: 420px){
      .wf-row{grid-template-columns:repeat(4, 1fr);}
      .btn{font-size:15px;min-height:52px;padding:12px 6px;}
    }
    @media (min-width: 768px){
      html{font-size:20px;}
      .main{max-width:880px;margin:0 auto;}
      .btn{font-size:18px;min-height:64px;}
      .input{font-size:22px;min-height:64px;}
      .key{min-height:72px;font-size:26px;}
    }

    .tsms-header{
      position:sticky; top:0; z-index:100;
      height:60px; background:#fff;
      border-bottom:2px solid #000;
      display:flex; align-items:center;
      padding:0 14px 0 56px;
      font-weight:900; font-size:20px;
    }
    .header-to-report{
      margin-left:auto;
      border:2px solid #000;
      padding:6px 10px;
      font-size:14px;
      font-weight:900;
      color:#000;
      text-decoration:none;
      line-height:1.2;
      background:#fff;
    }
    .tsms-hamburger{
      position:absolute; left:14px; top:50%;
      transform:translateY(-50%);
      width:32px; height:24px;
      display:flex; flex-direction:column; justify-content:space-between;
      cursor:pointer; user-select:none;
    }
    .tsms-hamburger span{ height:3px; background:#000; display:block; }
    .tsms-menu{
      position:fixed; top:0; left:0; height:100%; width:280px;
      background:#fff; border-right:2px solid #000;
      transform:translateX(-100%);
      transition:transform .25s ease;
      z-index:1000; padding-top:60px;
    }
    .tsms-menu.open{ transform:translateX(0); }
    .tsms-menu a{
      display:block; padding:16px;
      border-bottom:1px solid #ddd;
      text-decoration:none; color:#000;
      font-size:18px; font-weight:900;
    }
    .tsms-menu small{ display:block; margin-top:2px; font-size:12px; font-weight:700; color:#666; }
    .tsms-menu-bg{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
      z-index:900;
    }
    .tsms-menu-bg.show{ opacity:1; pointer-events:auto; }
  /* ---- Theme tokens ---- */
:root{
  --bg:#F3F6F8;
  --surface-1:#FFFFFF;
  --surface-2:#EEF3F6;
  --border:#D5DEE6;
  --text-primary:#0F1720;
  --text-secondary:#344554;
  --text-muted:#5B6D7C;
  --accent:#2580ED;
  --accent-hover:#4DA3FF;
  --link:#187FBF;
}
:root[data-theme="dark"]{
  --bg:#0F1417;
  --surface-1:#151C20;
  --surface-2:#1B242A;
  --border:#2A353D;
  --text-primary:#E6EEF3;
  --text-secondary:#B7C4CC;
  --text-muted:#8A949A;
  --accent:#3B95F0;
  --accent-hover:#4DA3FF;
  --link:#58C2FF;
}
html,body{ background:var(--bg)!important; color:var(--text-primary)!important; }
a{ color:var(--link); }
.tsms-header,.header,.app-header,.card,.wf-panel,.section,.date-switcher,.menu,.tsms-menu,.box{background:var(--surface-1)!important;border-color:var(--border)!important;color:var(--text-primary)!important;}
.note,.wf-field-label,.label,.k,.idx,.desc,.wf-subnote,.wf-field-label{color:var(--text-muted)!important;}
.tsms-menu a,.menu a,.header-to-report,.btn,.actionBtn,.key,.input,select,.key.small{background:var(--surface-2)!important;color:var(--text-primary)!important;border-color:var(--border)!important;}
.menu small,.tsms-menu small{color:var(--text-muted)!important;}
.btn.next{background:var(--accent)!important;border-color:var(--accent)!important;color:#fff!important;}
.menu-bg,.tsms-menu-bg{background:rgba(15,23,32,.35)!important;}

.hamburger span,.tsms-hamburger span{background:#58C2FF!important;}
/* ---- Theme tokens end ---- */

</style>
<link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TSMS">
  <script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>

<style id="tsms-bottom-nav-style">
  body{padding-bottom:78px;}
  .tsms-hamburger,.hamburger,.tsms-menu,.menu,.tsms-menu-bg,.menu-bg{display:none!important;}
  .tsms-header,.header{padding-left:14px!important;}
  .tsms-bottom-nav{position:fixed;left:0;right:0;bottom:0;z-index:1200;display:grid;grid-template-columns:repeat(5,1fr);background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);padding-bottom:env(safe-area-inset-bottom);}
  .tsms-bottom-nav a,.tsms-bottom-nav button{appearance:none;border:0;background:transparent;color:var(--text-secondary,#445);font:inherit;font-size:11px;font-weight:900;padding:8px 2px 9px;min-height:58px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;text-decoration:none;}
  .tsms-bottom-nav .ico{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;color:#58C2FF;}
  .tsms-bottom-nav .ico svg{width:22px;height:22px;stroke:#58C2FF;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;display:block;}
  .tsms-bottom-nav .active{color:var(--text-primary,#111);position:relative;}
  .tsms-bottom-nav .active::before{content:"";position:absolute;top:0;left:14%;right:14%;height:2px;background:#58C2FF;}
  .tsms-more-sheet{position:fixed;left:0;right:0;bottom:0;z-index:1300;background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);transform:translateY(110%);transition:transform .2s ease;padding:12px 12px calc(12px + env(safe-area-inset-bottom));}
  .tsms-more-sheet.show{transform:translateY(0);}
  .tsms-more-sheet a{display:block;padding:12px;border:2px solid var(--border,#ccc);margin-top:8px;text-decoration:none;color:var(--text-primary,#111);background:var(--surface-2,#f5f5f5);font-weight:900;}
  .tsms-more-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;z-index:1250;transition:opacity .2s;}
  .tsms-more-bg.show{opacity:1;pointer-events:auto;}

  .confirm-modal-bg{
    position:fixed;inset:0;z-index:1400;
    background:rgba(0,0,0,.45);
    display:none;align-items:center;justify-content:center;
    padding:16px;
  }
  .confirm-modal-bg.show{display:flex;}
  .confirm-modal-card{
    width:min(560px,100%);
    background:var(--surface-1,#fff);
    border:2px solid var(--border,#ccc);
    padding:14px;
  }
  .confirm-modal-title{font-size:18px;font-weight:900;margin:0 0 10px;}
  .confirm-modal-list{display:grid;gap:6px;margin:0 0 12px;}
  .confirm-modal-item{
    display:grid;grid-template-columns:110px 1fr;gap:8px;
    font-size:14px;line-height:1.4;
    border-bottom:1px solid var(--border,#ddd);padding-bottom:4px;
  }
  .confirm-modal-key{color:var(--text-muted,#666);font-weight:700;}
  .confirm-modal-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;}

  .submit-confirm-modal-card{
    width:min(560px,100%);
    border-radius:16px;
    border:1px solid #3d5f94;
    background:
      radial-gradient(120% 100% at 50% 0%, rgba(86,148,255,.18), rgba(10,21,44,0) 55%),
      linear-gradient(180deg, #0f1f42 0%, #0a1733 100%);
    box-shadow:0 10px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(126,167,235,.22) inset;
    padding:12px;
  }
  .submit-confirm-modal-head{
    display:grid;
    grid-template-columns:1fr auto;
    align-items:end;
    gap:8px;
    margin:0 0 8px;
    padding:2px 4px 10px;
    border-bottom:1px solid rgba(135,168,220,.45);
  }
  .submit-confirm-modal-step{
    margin:0;
    color:#c8ddff;
    font-size:24px;
    line-height:1;
    font-weight:900;
    letter-spacing:.01em;
  }
  .submit-confirm-modal-card .confirm-modal-title{
    margin:0;
    color:#eaf3ff;
    font-size:clamp(22px,6.2vw,30px);
    line-height:1.1;
  }
  .submit-confirm-modal-card .confirm-modal-list{
    border:1px solid rgba(125,164,230,.34);
    border-radius:10px;
    background:linear-gradient(180deg, rgba(16,31,62,.86) 0%, rgba(13,26,52,.86) 100%);
    padding:0 10px;
    gap:0;
  }
  .submit-confirm-modal-card .confirm-modal-item{
    grid-template-columns:120px 1fr;
    gap:10px;
    font-size:15px;
    line-height:1.4;
    border-bottom:1px solid rgba(125,164,230,.34);
    color:#e8f2ff;
    padding:8px 0;
  }
  .submit-confirm-modal-card .confirm-modal-item:last-child{border-bottom:0;}
  .submit-confirm-modal-card .confirm-modal-key{color:#bdd6fa;font-weight:700;}
  .submit-confirm-modal-card .confirm-modal-actions .btn{
    min-height:52px;
    border-radius:10px;
    font-size:17px;
    font-weight:900;
  }

  .result-modal-bg{
    position:fixed;inset:0;z-index:1450;
    background:rgba(0,0,0,.45);
    display:none;align-items:center;justify-content:center;
    padding:16px;
  }
  .result-modal-bg.show{display:flex;}
  .result-modal-card{
    width:min(320px,100%);
    background:var(--surface-1,#fff);
    border:2px solid var(--border,#ccc);
    padding:18px 14px 14px;
    text-align:center;
  }
  .result-modal-icon{
    width:56px;height:56px;margin:0 auto 12px;
    border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:28px;font-weight:900;line-height:1;
  }
  .result-modal-icon.success{background:#1ea44a;}
  .result-modal-icon.error{background:#d93025;}
  .result-modal-message{margin:0 0 14px;font-size:18px;font-weight:900;line-height:1.35;white-space:pre-line;}
  .result-modal-actions{display:grid;grid-template-columns:1fr;gap:8px;}
  .voice-input-modal-card{
    width:min(520px,100%);
    border-radius:16px;
    border:1px solid #3d5f94;
    background:
      radial-gradient(120% 100% at 50% 0%, rgba(86,148,255,.18), rgba(10,21,44,0) 55%),
      linear-gradient(180deg, #0f1f42 0%, #0a1733 100%);
    box-shadow:0 10px 28px rgba(0,0,0,.45), 0 0 0 1px rgba(126,167,235,.22) inset;
    padding:12px;
  }
  .voice-input-modal-head{
    display:grid;
    grid-template-columns:1fr auto;
    align-items:end;
    gap:8px;
    margin:0 0 8px;
    padding:2px 4px 10px;
    border-bottom:1px solid rgba(135,168,220,.45);
  }
  .voice-input-modal-head .confirm-modal-title{
    margin:0;
    color:#eaf3ff;
    font-size:clamp(22px,6.2vw,30px);
    line-height:1.1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .voice-input-modal-step{
    margin:0;
    color:#c8ddff;
    font-size:24px;
    line-height:1;
    font-weight:900;
    letter-spacing:.01em;
  }
  .voice-input-modal-body{
    border:1px solid rgba(125,164,230,.34);
    border-radius:10px;
    background:linear-gradient(180deg, rgba(16,31,62,.86) 0%, rgba(13,26,52,.86) 100%);
    padding:10px;
    margin:0 0 12px;
    text-align:left;
  }
  .voice-input-modal-prompt{
    margin:0 0 8px;
    font-size:15px;
    color:#d3e6ff;
    font-weight:900;
    line-height:1.35;
  }
  .voice-input-modal-status{
    margin:0 0 8px;
    font-size:13px;
    color:#bdd6fa;
    line-height:1.3;
  }
  .voice-input-modal-transcript{
    margin:0;
    min-height:44px;
    border:1px solid rgba(125,164,230,.42);
    border-radius:8px;
    background:rgba(11,23,44,.9);
    padding:8px 10px;
    font-size:14px;
    color:#e8f2ff;
    line-height:1.35;
    word-break:break-word;
    white-space:pre-wrap;
  }
  .voice-input-modal-dynamic{margin-top:8px;display:grid;gap:8px;}
  .voice-choice-guide,
  .voice-amount-guide{
    margin:0;
    font-size:13px;
    color:#bdd6fa;
    font-weight:700;
  }
  .voice-choice-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:8px;
  }
  .voice-choice-btn{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    gap:10px;
    min-height:58px;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #4a6695 !important;
    background:linear-gradient(180deg, rgba(31,52,96,.95) 0%, rgba(17,33,67,.95) 100%) !important;
  }
  .voice-choice-btn.is-selected{
    border-color:#62abff !important;
    background:linear-gradient(180deg, #2b7fe5 0%, #1e5fbb 100%) !important;
  }
  .voice-choice-no{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:28px;
    height:28px;
    border:1px solid #7ea6df;
    border-radius:999px;
    color:#d6e8ff;
    font-size:14px;
    font-weight:900;
    line-height:1;
    background:rgba(10,20,40,.75);
  }
  .voice-choice-label{
    color:#f1f7ff;
    font-size:clamp(20px,5.8vw,30px);
    font-weight:900;
    line-height:1.05;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .voice-amount-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;}
  .voice-amount-grid.single{grid-template-columns:1fr;}
  .voice-amount-box{
    border:1px solid rgba(125,164,230,.42);
    border-radius:10px;
    background:rgba(11,23,44,.9);
    padding:10px;
  }
  .voice-amount-box.active{
    border-color:#62abff;
    box-shadow:0 0 0 1px rgba(98,171,255,.28) inset;
  }
  .voice-amount-label{
    margin:0 0 6px;
    font-size:12px;
    color:#bdd6fa;
    font-weight:700;
  }
  .voice-amount-value{
    font-size:clamp(32px,10vw,54px);
    font-weight:900;
    line-height:1.05;
    text-align:right;
    color:#f2f8ff;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .voice-input-modal-actions{
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:8px;
  }
  .voice-input-modal-actions.is-binary{grid-template-columns:repeat(2,minmax(0,1fr));}
  .voice-input-modal-actions.is-single{grid-template-columns:1fr;}
  .voice-input-modal-actions .btn{
    min-height:52px;
    border-radius:10px;
    font-size:17px;
    font-weight:900;
  }
  .voice-input-modal-actions .btn[hidden]{display:none !important;}

</style>

  <script type="module" src="auth-guard.js?v=20260223-5"></script>
  <script src="./custom-confirm.js"></script>
  <link rel="stylesheet" href="./tsms-design.css?v=20260227-3">
</head>
<body>
<nav class="tsms-menu" id="tsmsMenu" aria-label="サイドメニュー">
  <a href="index.html">TOP<small>メニュー一覧</small></a>
  <a href="report.html">日報入力<small>乗車データを入力</small></a>
  <a href="confirm.html">入力確認<small>当日・過去のデータを確認</small></a>
  <a href="detail.html">詳細確認<small>概算手取、集計結果など</small></a>
  <a href="ops.html">出庫 / 帰庫 / 休憩<small>休憩タイマーなど</small></a>
  <a href="sales.html">月間管理<small>当月、過去の売上確認</small></a>
  <a href="settings.html">設定<small>歩率、締め期間、シフトなど</small></a>
</nav>
<div class="tsms-menu-bg" id="tsmsMenuBg" aria-hidden="true"></div>

<header class="tsms-header">
  <div class="tsms-hamburger" id="tsmsHamburger" role="button" tabindex="0" aria-label="メニュー">
    <span></span><span></span><span></span>
  </div>
  日報入力
  <a class="header-to-report" href="report.html">入力画面へ</a>
</header>

<main class="main">
  <section class="wf-panel" id="sec_rideType">
    <div class="wf-label">乗車種別</div>
    <div class="wf-row">
      <button class="btn" type="button" data-group="rideType" data-value="無線">無線</button><button class="btn" type="button" data-group="rideType" data-value="付待">付待</button><button class="btn" type="button" data-group="rideType" data-value="流し">流し</button><button class="btn" type="button" data-group="rideType" data-value="乗場">乗場</button><button class="btn" type="button" data-group="rideType" data-value="連続">連続</button><button class="btn" type="button" data-group="rideType" data-value="会社">会社</button><button class="btn" type="button" data-group="rideType" data-value="予約">予約</button><button class="btn" type="button" data-group="rideType" data-value="GO">GO</button>
    </div>
  </section>

  <section class="wf-panel" id="sec_payMethod">
    <div class="wf-label">支払方法</div>
    <div class="wf-row">
      <button class="btn" type="button" data-group="payMethod" data-value="現金">現金</button><button class="btn" type="button" data-group="payMethod" data-value="QR">QR</button><button class="btn" type="button" data-group="payMethod" data-value="クレカ">クレカ</button><button class="btn" type="button" data-group="payMethod" data-value="電子M">電子M</button><button class="btn" type="button" data-group="payMethod" data-value="チケット他">チケット他</button><button class="btn" type="button" data-group="payMethod" data-value="GO pay">GO pay</button><button class="btn" type="button" data-group="payMethod" data-value="乗込GO Pay">乗込GO Pay</button>
    </div>
  </section>

  <section class="wf-panel is-hidden" id="sec_ticketSub">
    <div class="wf-label">チケット他（追加選択）</div>
    <div class="wf-subnote">※「チケット他」選択時のみ表示</div>
    <div class="wf-row">
      <button class="btn" type="button" data-group="ticketSub" data-value="Aチケット">Aチケット</button><button class="btn" type="button" data-group="ticketSub" data-value="自社チケット">自社チケット</button><button class="btn" type="button" data-group="ticketSub" data-value="臨時チケット">臨時チケット</button><button class="btn" type="button" data-group="ticketSub" data-value="JCBチケット">JCBチケット</button><button class="btn" type="button" data-group="ticketSub" data-value="福祉チケット">福祉チケット</button><button class="btn" type="button" data-group="ticketSub" data-value="社内扱い">社内扱い</button><button class="btn" type="button" data-group="ticketSub" data-value="その他">その他</button><button class="btn" type="button" data-group="ticketSub" data-value="GOチケット">GOチケット</button>
    </div>
  </section>

  <section class="wf-panel" id="sec_amounts">
    <div class="wf-label">金額入力</div>
    <div class="wf-form">
      <div class="wf-field" id="row_cash">
        <div class="wf-field-label" hidden>現収（数字のみ）</div>
        <input class="input" id="in_cash" inputmode="none" placeholder="現収（数字のみ）" aria-label="現収（数字のみ）" readonly aria-readonly="true">
      </div>

      <div class="wf-field" id="row_credit">
        <div class="wf-field-label" hidden>未収（数字のみ）</div>
        <input class="input" id="in_credit" inputmode="none" placeholder="未収（数字のみ）" aria-label="未収（数字のみ）" readonly aria-readonly="true">
      </div>

      <div class="wf-field">
        <div class="wf-field-label" hidden>備考</div>
        <div class="wf-inline">
          <input class="input" id="in_note" placeholder="備考" aria-label="備考">
          <button class="btn" type="button" id="btn_discount">障害割引</button>
        </div>
      </div>

      <div class="wf-actions">
        <button class="btn" type="button" id="btn_clear">入力をクリア</button>
        <button class="btn" type="button" id="btn_submit">登録する</button>
      </div>
    </div>

  </section>

  <section class="wf-panel" id="sec_keypad">
    <div class="wf-label">テンキー</div>
    <div class="keypad" id="keypad">
      <div class="keypad-grid">
        <button class="key" type="button" data-key="1">1</button>
        <button class="key" type="button" data-key="2">2</button>
        <button class="key" type="button" data-key="3">3</button>
        <button class="key" type="button" data-key="4">4</button>
        <button class="key" type="button" data-key="5">5</button>
        <button class="key" type="button" data-key="6">6</button>
        <button class="key" type="button" data-key="7">7</button>
        <button class="key" type="button" data-key="8">8</button>
        <button class="key" type="button" data-key="9">9</button>
        <button class="key" type="button" data-key="0">0</button>
        <button class="key" type="button" data-key="00">00</button>
        <button class="key small" type="button" data-key="back">BS</button>
      </div>
    </div>
  </section>
</main>

<div class="confirm-modal-bg" id="submitConfirmModalBg" aria-hidden="true">
  <div class="confirm-modal-card submit-confirm-modal-card" role="dialog" aria-modal="true" aria-labelledby="submitConfirmTitle">
    <div class="submit-confirm-modal-head">
      <p class="confirm-modal-title" id="submitConfirmTitle">この内容で登録しますか？</p>
      <p class="submit-confirm-modal-step">8/8</p>
    </div>
    <div class="confirm-modal-list">
      <div class="confirm-modal-item"><span class="confirm-modal-key">乗車種別</span><span id="confirmRideType">-</span></div>
      <div class="confirm-modal-item"><span class="confirm-modal-key">支払方法</span><span id="confirmPayMethod">-</span></div>
      <div class="confirm-modal-item"><span class="confirm-modal-key">チケット種別</span><span id="confirmTicketSub">-</span></div>
      <div class="confirm-modal-item"><span class="confirm-modal-key">現収</span><span id="confirmCash">0</span></div>
      <div class="confirm-modal-item"><span class="confirm-modal-key">未収</span><span id="confirmCredit">0</span></div>
      <div class="confirm-modal-item"><span class="confirm-modal-key">障害割引</span><span id="confirmDiscount">なし</span></div>
      <div class="confirm-modal-item"><span class="confirm-modal-key">備考</span><span id="confirmNote">-</span></div>
    </div>
    <div class="confirm-modal-actions">
      <button class="btn" type="button" id="confirmNoBtn">いいえ</button>
      <button class="btn next" type="button" id="confirmYesBtn">はい</button>
    </div>
  </div>
</div>

<div class="result-modal-bg" id="resultModalBg" aria-hidden="true">
  <div class="result-modal-card" role="dialog" aria-modal="true" aria-labelledby="resultModalMessage">
    <div class="result-modal-icon success" id="resultModalIcon" aria-hidden="true">○</div>
    <p class="result-modal-message" id="resultModalMessage">登録が完了しました</p>
    <div class="result-modal-actions">
      <button class="btn" type="button" id="resultModalCloseBtn">閉じる</button>
    </div>
  </div>
</div>

<div class="confirm-modal-bg" id="voiceInputModalBg" aria-hidden="true">
  <div class="confirm-modal-card voice-input-modal-card" role="dialog" aria-modal="true" aria-labelledby="voiceInputModalTitle">
    <div class="voice-input-modal-head">
      <p class="confirm-modal-title" id="voiceInputModalTitle">音声入力を開始しますか？</p>
      <p class="voice-input-modal-step" id="voiceInputModalStep">開始確認</p>
    </div>
    <div class="voice-input-modal-body">
      <p class="voice-input-modal-prompt" id="voiceInputModalPrompt">「はい」で音声入力を開始します。</p>
      <p class="voice-input-modal-status" id="voiceInputModalStatus">手動入力は従来どおり利用できます。</p>
      <p class="voice-input-modal-transcript" id="voiceInputModalTranscript">-</p>
      <div class="voice-input-modal-dynamic" id="voiceInputModalDynamic"></div>
    </div>
    <div class="confirm-modal-actions voice-input-modal-actions is-binary" id="voiceInputModalActions">
      <button class="btn" type="button" id="voiceInputModalCancelBtn">いいえ</button>
      <button class="btn" type="button" id="voiceInputModalRetryBtn" hidden>やり直し</button>
      <button class="btn next" type="button" id="voiceInputModalOkBtn">はい</button>
    </div>
  </div>
</div>

<script>
(() => {
  const REPORT_KEY = "tsms_reports";
  const CURRENT_DAY_KEY = "tsms_report_current_day";
  const CONFIRM_FORCE_EMPTY_KEY = "tsms_confirm_force_empty";
  const state = { rideType: "", payMethod: "", ticketSub: "", disabilityDiscount: false };
  const secTicket = document.getElementById("sec_ticketSub");
  const secAmounts = document.getElementById("sec_amounts");
  const rowCash = document.getElementById("row_cash");
  const rowCredit = document.getElementById("row_credit");
  const inCash = document.getElementById("in_cash");
  const inCredit = document.getElementById("in_credit");
  const inNote = document.getElementById("in_note");
  const btnDiscount = document.getElementById("btn_discount");
  const btnClear = document.getElementById("btn_clear");
  const btnSubmit = document.getElementById("btn_submit");
  const submitConfirmModalBg = document.getElementById("submitConfirmModalBg");
  const confirmRideType = document.getElementById("confirmRideType");
  const confirmPayMethod = document.getElementById("confirmPayMethod");
  const confirmTicketSub = document.getElementById("confirmTicketSub");
  const confirmCash = document.getElementById("confirmCash");
  const confirmCredit = document.getElementById("confirmCredit");
  const confirmDiscount = document.getElementById("confirmDiscount");
  const confirmNote = document.getElementById("confirmNote");
  const confirmNoBtn = document.getElementById("confirmNoBtn");
  const confirmYesBtn = document.getElementById("confirmYesBtn");
  const resultModalBg = document.getElementById("resultModalBg");
  const resultModalIcon = document.getElementById("resultModalIcon");
  const resultModalMessage = document.getElementById("resultModalMessage");
  const resultModalCloseBtn = document.getElementById("resultModalCloseBtn");
  const voiceInputModalBg = document.getElementById("voiceInputModalBg");
  const voiceInputModalTitle = document.getElementById("voiceInputModalTitle");
  const voiceInputModalStep = document.getElementById("voiceInputModalStep");
  const voiceInputModalPrompt = document.getElementById("voiceInputModalPrompt");
  const voiceInputModalStatus = document.getElementById("voiceInputModalStatus");
  const voiceInputModalTranscript = document.getElementById("voiceInputModalTranscript");
  const voiceInputModalActions = document.getElementById("voiceInputModalActions");
  const voiceInputModalDynamic = document.getElementById("voiceInputModalDynamic");
  const voiceInputModalCancelBtn = document.getElementById("voiceInputModalCancelBtn");
  const voiceInputModalRetryBtn = document.getElementById("voiceInputModalRetryBtn");
  const voiceInputModalOkBtn = document.getElementById("voiceInputModalOkBtn");
  let focused = inCash;
  let voiceFlowAbortRequested = false;
  let activeVoiceRecognition = null;
  let voiceModalEscHandler = null;
  let voiceSkipNextSubmitConfirm = false;
  let voiceSubmitSuccessAutoRedirectSeconds = 0;

  function todayLocalYmd() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function loadReports() {
    try {
      const list = JSON.parse(localStorage.getItem(REPORT_KEY) || "[]");
      return Array.isArray(list) ? list : [];
    } catch (_) {
      return [];
    }
  }

  function getCurrentDayId() {
    return localStorage.getItem(CURRENT_DAY_KEY) || "";
  }

  function resolveSaveDayId() {
    return getCurrentDayId() || todayLocalYmd();
  }

  function clearSelected(group) {
    document.querySelectorAll(`button[data-group="${group}"]`).forEach((b) => b.classList.remove("is-selected"));
  }

  function selectBtn(group, btn) {
    const already = btn.classList.contains("is-selected");
    clearSelected(group);
    if (already) return false;
    btn.classList.add("is-selected");
    return true;
  }

  function applyPayRules() {
    if (state.payMethod === "チケット他") secTicket.classList.remove("is-hidden");
    else secTicket.classList.add("is-hidden");

    if (state.payMethod === "現金") {
      rowCash.classList.remove("is-hidden");
      rowCredit.classList.add("is-hidden");
      focused = inCash;
    } else if (state.payMethod === "チケット他") {
      rowCash.classList.remove("is-hidden");
      rowCredit.classList.remove("is-hidden");
      focused = inCredit;
    } else {
      rowCash.classList.add("is-hidden");
      rowCredit.classList.remove("is-hidden");
      focused = inCredit;
    }
  }

  function scrollToAmountsIfReady() {
    if (!state.rideType || !state.payMethod) return;
    if (state.payMethod === "チケット他" && !state.ticketSub) {
      secTicket.scrollIntoView({ behavior: "smooth", block: "start" });
      return;
    }
    setTimeout(() => {
      secAmounts.scrollIntoView({ behavior: "smooth", block: "start" });
      (state.payMethod === "現金" ? inCash : inCredit).focus();
    }, 50);
  }

  function clearForm() {
    state.rideType = "";
    state.payMethod = "";
    state.ticketSub = "";
    state.disabilityDiscount = false;
    document.querySelectorAll('button[data-group]').forEach((b) => b.classList.remove("is-selected"));
    btnDiscount.classList.remove("is-selected");
    inCash.value = "";
    inCredit.value = "";
    inNote.value = "";
    rowCash.classList.remove("is-hidden");
    rowCredit.classList.remove("is-hidden");
    secTicket.classList.add("is-hidden");
    focused = inCash;
    inCash.focus();
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function formatAmountText(value) {
    const n = Number((value || "").replace(/[^0-9]/g, ""));
    if (!n) return "0";
    return n.toLocaleString("ja-JP");
  }

  function showSubmitConfirmModal(opts) {
    const options = (opts && typeof opts === "object") ? opts : {};
    if (!submitConfirmModalBg) return Promise.resolve(true);
    confirmRideType.textContent = state.rideType || "-";
    confirmPayMethod.textContent = state.payMethod || "-";
    confirmTicketSub.textContent = state.payMethod === "チケット他" ? (state.ticketSub || "-") : "-";
    confirmCash.textContent = formatAmountText(inCash.value);
    confirmCredit.textContent = formatAmountText(inCredit.value);
    confirmDiscount.textContent = state.disabilityDiscount ? "あり" : "なし";
    confirmNote.textContent = (inNote.value || "").trim() || "-";

    return new Promise((resolve) => {
      let closed = false;
      const close = (ok) => {
        if (closed) return;
        closed = true;
        submitConfirmModalBg.classList.remove("show");
        submitConfirmModalBg.setAttribute("aria-hidden", "true");
        confirmNoBtn.removeEventListener("click", onNo);
        confirmYesBtn.removeEventListener("click", onYes);
        submitConfirmModalBg.removeEventListener("click", onBg);
        document.removeEventListener("keydown", onEsc);
        if (options.voice) stopActiveVoiceRecognition();
        resolve(ok);
      };
      const onNo = () => close(false);
      const onYes = () => close(true);
      const onBg = (e) => {
        if (e.target === submitConfirmModalBg) close(false);
      };
      const onEsc = (e) => {
        if (e.key === "Escape") close(false);
      };

      submitConfirmModalBg.classList.add("show");
      submitConfirmModalBg.setAttribute("aria-hidden", "false");
      confirmNoBtn.addEventListener("click", onNo);
      confirmYesBtn.addEventListener("click", onYes);
      submitConfirmModalBg.addEventListener("click", onBg);
      document.addEventListener("keydown", onEsc);
      confirmNoBtn.focus();

      if (options.voice) {
        (async () => {
          await waitMs(450);
          if (closed) return;
          const voiceAnswer = await captureVoiceYesNo(
            "登録確認",
            "登録しますか？『はい』または『いいえ』と話してください。",
            { attempts: 2, useVoiceModal: false, timeoutMs: 9000 }
          );
          if (closed) return;
          if (!voiceAnswer.ok) {
            close(false);
            return;
          }
          close(voiceAnswer.yes);
        })().catch(() => {
          if (!closed) close(false);
        });
      }
    });
  }

  function showResultModal(message, opts) {
    const options = (opts && typeof opts === "object") ? opts : {};
    if (!resultModalBg || !resultModalIcon || !resultModalMessage || !resultModalCloseBtn) {
      alert(String(message || ""));
      return Promise.resolve();
    }
    const baseText = String(message || "");
    const isSuccess = baseText.includes("完了");
    const autoCloseSeconds = Math.max(0, Number(options.autoCloseSeconds || 0));
    const countdownLabel = String(options.countdownLabel || "入力確認画面へ移動します");
    const renderMessage = (remaining) => {
      if (autoCloseSeconds > 0 && Number.isFinite(remaining) && remaining > 0) {
        resultModalMessage.textContent = `${baseText}
${remaining}秒後に${countdownLabel}`;
        return;
      }
      resultModalMessage.textContent = baseText;
    };
    renderMessage(autoCloseSeconds);
    resultModalIcon.textContent = isSuccess ? "○" : "×";
    resultModalIcon.classList.toggle("success", isSuccess);
    resultModalIcon.classList.toggle("error", !isSuccess);

    return new Promise((resolve) => {
      let closed = false;
      let countdownInterval = null;
      let countdownTimeout = null;
      const close = () => {
        if (closed) return;
        closed = true;
        if (countdownInterval) clearInterval(countdownInterval);
        if (countdownTimeout) clearTimeout(countdownTimeout);
        resultModalBg.classList.remove("show");
        resultModalBg.setAttribute("aria-hidden", "true");
        resultModalCloseBtn.removeEventListener("click", onClose);
        resultModalBg.removeEventListener("click", onBg);
        document.removeEventListener("keydown", onEsc);
        resolve();
      };
      const onClose = () => close();
      const onBg = (e) => {
        if (e.target === resultModalBg) close();
      };
      const onEsc = (e) => {
        if (e.key === "Escape") close();
      };

      resultModalBg.classList.add("show");
      resultModalBg.setAttribute("aria-hidden", "false");
      resultModalCloseBtn.addEventListener("click", onClose);
      resultModalBg.addEventListener("click", onBg);
      document.addEventListener("keydown", onEsc);
      resultModalCloseBtn.focus();

      if (autoCloseSeconds > 0) {
        let remaining = autoCloseSeconds;
        countdownInterval = setInterval(() => {
          remaining -= 1;
          if (remaining <= 0) return;
          renderMessage(remaining);
        }, 1000);
        countdownTimeout = setTimeout(() => close(), autoCloseSeconds * 1000);
      }
    });
  }

  function setVoiceModalEscHandler(handler) {
    if (voiceModalEscHandler) {
      document.removeEventListener("keydown", voiceModalEscHandler);
      voiceModalEscHandler = null;
    }
    if (handler) {
      voiceModalEscHandler = handler;
      document.addEventListener("keydown", voiceModalEscHandler);
    }
  }

  function clearVoiceModalDynamic() {
    if (voiceInputModalDynamic) voiceInputModalDynamic.innerHTML = "";
  }

  function closeVoiceInputModal() {
    if (!voiceInputModalBg) return;
    voiceInputModalBg.classList.remove("show");
    voiceInputModalBg.setAttribute("aria-hidden", "true");
    if (voiceInputModalCancelBtn) voiceInputModalCancelBtn.onclick = null;
    if (voiceInputModalRetryBtn) voiceInputModalRetryBtn.onclick = null;
    if (voiceInputModalOkBtn) voiceInputModalOkBtn.onclick = null;
    voiceInputModalBg.onclick = null;
    clearVoiceModalDynamic();
    setVoiceModalEscHandler(null);
  }

  function openVoiceInputModal() {
    if (!voiceInputModalBg) return;
    voiceInputModalBg.classList.add("show");
    voiceInputModalBg.setAttribute("aria-hidden", "false");
  }

  function setVoiceInputModalState(opts) {
    if (!voiceInputModalBg) return;
    const o = opts || {};
    if (voiceInputModalTitle && "title" in o) voiceInputModalTitle.textContent = String(o.title || "");
    if (voiceInputModalStep && "step" in o) voiceInputModalStep.textContent = String(o.step || "");
    if (voiceInputModalPrompt && "prompt" in o) voiceInputModalPrompt.textContent = String(o.prompt || "");
    if (voiceInputModalStatus && "status" in o) voiceInputModalStatus.textContent = String(o.status || "");
    if (voiceInputModalTranscript && "transcript" in o) {
      const t = String(o.transcript || "").trim();
      voiceInputModalTranscript.textContent = t || "-";
    }
    if (voiceInputModalStep) voiceInputModalStep.hidden = !!o.hideStep;
    if (voiceInputModalPrompt) voiceInputModalPrompt.hidden = !!o.hidePrompt;
    if (voiceInputModalStatus) voiceInputModalStatus.hidden = !!o.hideStatus;
    if (voiceInputModalTranscript) voiceInputModalTranscript.hidden = !!o.hideTranscript;
    if (voiceInputModalCancelBtn && "cancelText" in o) voiceInputModalCancelBtn.textContent = String(o.cancelText || "");
    if (voiceInputModalRetryBtn && "retryText" in o) voiceInputModalRetryBtn.textContent = String(o.retryText || "");
    if (voiceInputModalOkBtn && "okText" in o) voiceInputModalOkBtn.textContent = String(o.okText || "");
    if (voiceInputModalCancelBtn && "hideCancel" in o) voiceInputModalCancelBtn.hidden = !!o.hideCancel;
    if (voiceInputModalRetryBtn && "hideRetry" in o) voiceInputModalRetryBtn.hidden = !!o.hideRetry;
    if (voiceInputModalOkBtn && "hideOk" in o) voiceInputModalOkBtn.hidden = !!o.hideOk;
    if (voiceInputModalActions) {
      voiceInputModalActions.classList.toggle("is-single", !!o.singleAction);
      voiceInputModalActions.classList.toggle("is-binary", !!o.binaryAction);
    }
  }

  function showVoiceStartModal() {
    if (!voiceInputModalBg || !voiceInputModalCancelBtn || !voiceInputModalOkBtn) {
      return Promise.resolve(false);
    }
    return new Promise((resolve) => {
      let done = false;
      const finish = (ok) => {
        if (done) return;
        done = true;
        closeVoiceInputModal();
        resolve(!!ok);
      };
      setVoiceInputModalState({
        title: "音声入力を開始しますか？",
        step: "",
        prompt: "",
        status: "※ブラウザでマイク許可の確認が表示された場合は「許可」を選んでください。許可しないと音声入力を開始できません。",
        transcript: "",
        hideStep: true,
        hidePrompt: true,
        hideStatus: false,
        hideTranscript: true,
        cancelText: "いいえ",
        retryText: "やり直し",
        okText: "はい",
        hideCancel: false,
        hideRetry: true,
        hideOk: false,
        singleAction: false,
        binaryAction: true
      });
      clearVoiceModalDynamic();
      voiceInputModalCancelBtn.onclick = () => finish(false);
      if (voiceInputModalRetryBtn) voiceInputModalRetryBtn.onclick = null;
      voiceInputModalOkBtn.onclick = () => finish(true);
      voiceInputModalBg.onclick = (e) => {
        if (e.target === voiceInputModalBg) finish(false);
      };
      setVoiceModalEscHandler((e) => {
        if (e.key === "Escape") finish(false);
      });
      openVoiceInputModal();
      voiceInputModalOkBtn.focus();
    });
  }

  function stopActiveVoiceRecognition() {
    if (!activeVoiceRecognition) return;
    try { activeVoiceRecognition.abort(); } catch (_) {}
  }

  function setupVoiceStageModal(titleText, stepLabel, promptText, statusText) {
    setVoiceInputModalState({
      title: titleText || "音声入力",
      step: stepLabel,
      prompt: promptText,
      status: statusText || "番号か項目をお話しください。",
      transcript: "-",
      hideTranscript: true,
      cancelText: "中止",
      retryText: "やり直し",
      okText: "OK",
      hideCancel: false,
      hideRetry: true,
      hideOk: true,
      singleAction: true,
      binaryAction: false
    });
    if (voiceInputModalRetryBtn) voiceInputModalRetryBtn.onclick = null;
    if (voiceInputModalOkBtn) voiceInputModalOkBtn.onclick = null;
    if (voiceInputModalCancelBtn) {
      voiceInputModalCancelBtn.onclick = () => {
        voiceFlowAbortRequested = true;
        setVoiceInputModalState({ status: "中止しています…" });
        stopActiveVoiceRecognition();
      };
    }
    if (voiceInputModalBg) {
      voiceInputModalBg.onclick = (e) => {
        if (e.target === voiceInputModalBg) {
          voiceFlowAbortRequested = true;
          stopActiveVoiceRecognition();
        }
      };
    }
    setVoiceModalEscHandler((e) => {
      if (e.key === "Escape") {
        voiceFlowAbortRequested = true;
        stopActiveVoiceRecognition();
      }
    });
    openVoiceInputModal();
  }

  function waitMs(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  function toAsciiBasic(str) {
    return String(str || "")
      .replace(/[！-～]/g, (c) => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
      .replace(/　/g, " ");
  }

  function normalizeVoiceText(text) {
    return toAsciiBasic(text)
      .toLowerCase()
      .replace(/\s+/g, "")
      .replace(/[、。,.，．・:：;；!?！？"'`´「」『』（）()［］\[\]【】]/g, "");
  }

  function extractVoiceDigits(text) {
    const asciiDigits = toAsciiBasic(text).replace(/[^\d]/g, "");
    if (asciiDigits) return asciiDigits;

    let t = normalizeVoiceText(text)
      .replace(/ー+/g, "")
      .replace(/円/g, "")
      .replace(/えん/g, "")
      .replace(/です/g, "")
      .replace(/お願いします/g, "")
      .replace(/おねがいします/g, "");

    if (!t) return "";

    const tokens = [
      ["ぜろ", "0"], ["れい", "0"], ["まる", "0"],
      ["いち", "1"],
      ["に", "2"],
      ["さん", "3"],
      ["よん", "4"], ["し", "4"],
      ["ご", "5"],
      ["ろく", "6"],
      ["なな", "7"], ["しち", "7"],
      ["はち", "8"],
      ["きゅう", "9"], ["く", "9"]
    ];

    let out = "";
    while (t) {
      let matched = false;
      for (const [word, digit] of tokens) {
        if (t.startsWith(word)) {
          out += digit;
          t = t.slice(word.length);
          matched = true;
          break;
        }
      }
      if (!matched) return "";
    }
    return out;
  }

  function resolveVoiceChoice(rawText, defs) {
    const text = normalizeVoiceText(rawText);
    if (!text) return "";
    let best = "";
    let bestLen = 0;
    defs.forEach((def) => {
      (def.aliases || []).forEach((alias) => {
        const key = normalizeVoiceText(alias);
        if (!key) return;
        if (text.includes(key) && key.length > bestLen) {
          best = def.value;
          bestLen = key.length;
        }
      });
    });
    return best;
  }

  function resolveVoiceIndex(rawText, max) {
    const digits = toAsciiBasic(rawText).replace(/[^\d]/g, "");
    if (digits) {
      const n = Number(digits);
      if (n >= 1 && n <= max) return n;
    }
    const norm = normalizeVoiceText(rawText);
    const wordMap = [
      ["いち", 1], ["に", 2], ["さん", 3], ["よん", 4], ["し", 4],
      ["ご", 5], ["ろく", 6], ["なな", 7], ["しち", 7], ["はち", 8], ["きゅう", 9], ["く", 9]
    ];
    for (const [word, num] of wordMap) {
      if (num > max) continue;
      if (norm === word || norm === `${word}ばん` || norm.startsWith(`${word}ばん`)) return num;
    }
    return 0;
  }

  function resolveVoiceChoiceOrIndex(rawText, defs) {
    const byWord = resolveVoiceChoice(rawText, defs);
    if (byWord) return byWord;
    const idx = resolveVoiceIndex(rawText, defs.length);
    if (idx >= 1) return defs[idx - 1].value;
    return "";
  }

  function setGroupSelectionDirect(group, value) {
    let hit = null;
    document.querySelectorAll(`button[data-group="${group}"]`).forEach((b) => {
      const v = b.dataset.value || b.textContent.trim();
      if (v === value) hit = b;
    });
    if (!hit) return false;
    clearSelected(group);
    hit.classList.add("is-selected");

    if (group === "rideType") state.rideType = value;
    if (group === "payMethod") {
      state.payMethod = value;
      if (value !== "チケット他") {
        state.ticketSub = "";
        clearSelected("ticketSub");
      }
      applyPayRules();
    }
    if (group === "ticketSub") state.ticketSub = value;
    return true;
  }

  function getSpeechRecognitionCtor() {
    return window.SpeechRecognition || window.webkitSpeechRecognition || null;
  }

  function recognizeSpeechOnceSilent(timeoutMs) {
    const Ctor = getSpeechRecognitionCtor();
    if (!Ctor) return Promise.resolve({ ok: false, error: "unsupported" });

    return new Promise((resolve) => {
      let settled = false;
      let finalText = "";
      let interimText = "";
      let errorCode = "";
      let timerId = null;
      const recognition = new Ctor();
      activeVoiceRecognition = recognition;
      recognition.lang = "ja-JP";
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;

      const finish = (payload) => {
        if (settled) return;
        settled = true;
        if (timerId) clearTimeout(timerId);
        recognition.onstart = null;
        recognition.onresult = null;
        recognition.onerror = null;
        recognition.onend = null;
        if (activeVoiceRecognition === recognition) activeVoiceRecognition = null;
        resolve(payload);
      };

      recognition.onresult = (event) => {
        let latestInterim = "";
        for (let i = event.resultIndex; i < event.results.length; i += 1) {
          const item = event.results[i];
          const transcript = item && item[0] ? String(item[0].transcript || "") : "";
          if (!transcript) continue;
          if (item.isFinal) finalText += transcript;
          else latestInterim += transcript;
        }
        interimText = latestInterim;
      };

      recognition.onerror = (event) => {
        errorCode = (event && event.error) ? String(event.error) : "error";
      };

      recognition.onend = () => {
        if (voiceFlowAbortRequested) {
          finish({ ok: false, cancelled: true, error: "aborted" });
          return;
        }
        const text = (finalText || interimText || "").trim();
        if (text) {
          finish({ ok: true, text });
          return;
        }
        finish({ ok: false, error: errorCode || "no-speech" });
      };

      try {
        recognition.start();
        timerId = setTimeout(() => {
          try { recognition.stop(); } catch (_) {}
        }, Math.max(3000, Number(timeoutMs || 9000)));
      } catch (_) {
        finish({ ok: false, error: "start-failed" });
      }
    });
  }

  function renderVoiceChoiceOptions(defs, selectedValue, onPick, opts) {
    if (!voiceInputModalDynamic) return;
    voiceInputModalDynamic.innerHTML = "";

    const o = opts || {};
    if (typeof o.beforeRender === "function") o.beforeRender(voiceInputModalDynamic);

    const guide = document.createElement("p");
    guide.className = "voice-choice-guide";
    guide.textContent = o.guideText || "番号か項目をお話しください。タップでも選択できます。";
    voiceInputModalDynamic.appendChild(guide);

    const grid = document.createElement("div");
    grid.className = "voice-choice-grid";
    defs.forEach((def, i) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn voice-choice-btn" + (selectedValue === def.value ? " is-selected" : "");
      btn.dataset.value = def.value;

      const no = document.createElement("span");
      no.className = "voice-choice-no";
      no.textContent = String(i + 1);

      const label = document.createElement("span");
      label.className = "voice-choice-label";
      label.textContent = def.label || def.value;

      btn.appendChild(no);
      btn.appendChild(label);
      btn.addEventListener("click", () => onPick(def.value));
      grid.appendChild(btn);
    });
    voiceInputModalDynamic.appendChild(grid);
  }

  function renderVoiceAmountBoxes(opts) {
    if (!voiceInputModalDynamic) return;
    const o = opts || {};
    const showCash = !!o.showCash;
    const showCredit = !!o.showCredit;
    const activeField = o.activeField || "cash";

    voiceInputModalDynamic.innerHTML = "";

    const guide = document.createElement("p");
    guide.className = "voice-amount-guide";
    guide.textContent = "数字で話してください。必要に応じて「なし」も使えます。";
    voiceInputModalDynamic.appendChild(guide);

    const grid = document.createElement("div");
    grid.className = "voice-amount-grid" + ((showCash && showCredit) ? "" : " single");

    const makeBox = (label, value, active) => {
      const box = document.createElement("div");
      box.className = "voice-amount-box" + (active ? " active" : "");
      const k = document.createElement("p");
      k.className = "voice-amount-label";
      k.textContent = label;
      const v = document.createElement("div");
      v.className = "voice-amount-value";
      const digits = String(value || "").trim();
      v.textContent = digits ? formatAmountText(digits) : "-";
      box.appendChild(k);
      box.appendChild(v);
      return box;
    };

    if (showCash) grid.appendChild(makeBox("現収", inCash.value, activeField === "cash"));
    if (showCredit) grid.appendChild(makeBox("未収", inCredit.value, activeField === "credit"));
    voiceInputModalDynamic.appendChild(grid);
  }

  function appendVoiceAmountSnapshot(parent, opts) {
    const host = parent || voiceInputModalDynamic;
    if (!host) return;
    const o = opts || {};
    const showCash = ("showCash" in o) ? !!o.showCash : true;
    const showCredit = ("showCredit" in o) ? !!o.showCredit : true;
    const activeField = o.activeField || "";

    const heading = document.createElement("p");
    heading.className = "voice-amount-guide";
    heading.textContent = o.guideText || "現在の入力金額";
    host.appendChild(heading);

    const grid = document.createElement("div");
    grid.className = "voice-amount-grid" + ((showCash && showCredit) ? "" : " single");

    const makeBox = (label, value, active) => {
      const box = document.createElement("div");
      box.className = "voice-amount-box" + (active ? " active" : "");
      const k = document.createElement("p");
      k.className = "voice-amount-label";
      k.textContent = label;
      const v = document.createElement("div");
      v.className = "voice-amount-value";
      const digits = String(value || "").trim();
      v.textContent = digits ? formatAmountText(digits) : "-";
      box.appendChild(k);
      box.appendChild(v);
      return box;
    };

    if (showCash) grid.appendChild(makeBox("現収", inCash.value, activeField === "cash"));
    if (showCredit) grid.appendChild(makeBox("未収", inCredit.value, activeField === "credit"));
    host.appendChild(grid);
  }

  const VOICE_RIDE_TYPE_DEFS = [
    { value: "無線", label: "無線", aliases: ["無線"] },
    { value: "付待", label: "付待", aliases: ["付待", "付け待ち", "つけまち", "付待ち"] },
    { value: "流し", label: "流し", aliases: ["流し"] },
    { value: "乗場", label: "乗場", aliases: ["乗場", "のりば", "乗り場"] },
    { value: "GO", label: "GO", aliases: ["go", "GO", "ゴー"] },
    { value: "会社", label: "会社", aliases: ["会社"] },
    { value: "予約", label: "予約", aliases: ["予約"] },
    { value: "連続", label: "連続", aliases: ["連続"] }
  ];

  const VOICE_PAY_METHOD_DEFS = [
    { value: "現金", label: "現金", aliases: ["現金", "げんきん"] },
    { value: "QR", label: "QR", aliases: ["qr", "qrコード", "キューアール", "ペイペイ", "paypay"] },
    { value: "クレカ", label: "クレカ", aliases: ["クレカ", "クレジット", "カード"] },
    { value: "電子M", label: "電子M", aliases: ["電子m", "電子マネー", "でんしまねー"] },
    { value: "チケット他", label: "チケット他", aliases: ["チケット他", "チケット", "ticket", "チケットそのた"] },
    { value: "GO pay", label: "GO pay", aliases: ["gopay", "go pay", "ゴーペイ"] },
    { value: "乗込GO Pay", label: "乗込GO Pay", aliases: ["乗込gopay", "乗り込みgopay", "乗込go pay", "乗り込みgo pay", "乗込go", "乗り込みgo"] }
  ];

  const VOICE_TICKET_SUB_DEFS = [
    { value: "Aチケット", label: "Aチケット", aliases: ["aチケット", "エーチケット"] },
    { value: "自社チケット", label: "自社チケット", aliases: ["自社チケット", "じしゃチケット"] },
    { value: "臨時チケット", label: "臨時チケット", aliases: ["臨時チケット", "りんじチケット"] },
    { value: "JCBチケット", label: "JCBチケット", aliases: ["jcbチケット", "jcb", "ジェーシービー"] },
    { value: "福祉チケット", label: "福祉チケット", aliases: ["福祉チケット", "ふくしチケット"] },
    { value: "社内扱い", label: "社内扱い", aliases: ["社内扱い", "しゃないあつかい"] },
    { value: "その他", label: "その他", aliases: ["その他", "そのた"] },
    { value: "GOチケット", label: "GOチケット", aliases: ["goチケット", "g oチケット", "ゴーチケット"] }
  ];

  const VOICE_YES_NO_DEFS = [
    { value: "yes", label: "はい", aliases: ["はい", "ok", "オーケー", "おっけー", "いいよ"] },
    { value: "no", label: "いいえ", aliases: ["いいえ", "いや", "キャンセル", "だめ", "ダメ", "やめる"] }
  ];

  const VOICE_REVIEW_ACTION_DEFS = [
    { value: "cancel", label: "中止", aliases: ["中止", "ちゅうし", "キャンセル", "やめる", "終了"] },
    { value: "retry", label: "やり直し", aliases: ["やり直し", "やりなおし", "修正", "再入力", "もう一度"] },
    { value: "ok", label: "OK", aliases: ["ok", "オーケー", "おーけー", "おっけー", "オッケー", "確定", "次へ", "進む"] }
  ];

  async function captureVoiceChoice(stepLabel, promptText, defs, applyFn, opts) {
    const o = opts || {};
    const stageTitle = String(o.title || "音声入力");
    let manualValue = "";
    let attempt = 0;

    const applySelection = (value, transcript) => {
      if (typeof applyFn === "function") {
        const ok = applyFn(value, transcript);
        if (!ok) return false;
      }
      renderVoiceChoiceOptions(defs, value, (picked) => {
        manualValue = picked;
        stopActiveVoiceRecognition();
      }, o);
      setVoiceInputModalState({
        title: stageTitle,
        step: stepLabel,
        prompt: promptText,
        status: `「${(defs.find((d) => d.value === value) || {}).label || value}」を反映しました。`,
        transcript: transcript || value
      });
      return true;
    };

    setupVoiceStageModal(stageTitle, stepLabel, promptText, "番号か項目をお話しください。");
    renderVoiceChoiceOptions(defs, "", (picked) => {
      manualValue = picked;
      stopActiveVoiceRecognition();
    }, o);

    while (!voiceFlowAbortRequested) {
      if (manualValue) {
        const value = manualValue;
        manualValue = "";
        if (applySelection(value, "タップ選択")) {
          await waitMs(220);
          return { ok: true, value, rawText: "tap" };
        }
      }

      attempt += 1;
      setVoiceInputModalState({
        title: stageTitle,
        step: stepLabel,
        prompt: promptText,
        status: `番号か項目をお話しください（${attempt}回目）`,
        transcript: "-"
      });

      const result = await recognizeSpeechOnceSilent(9000);
      if (voiceFlowAbortRequested) return { ok: false, cancelled: true };

      if (manualValue) {
        const value = manualValue;
        manualValue = "";
        if (applySelection(value, "タップ選択")) {
          await waitMs(220);
          return { ok: true, value, rawText: "tap" };
        }
      }

      if (!result.ok) {
        setVoiceInputModalState({
          title: stageTitle,
          step: stepLabel,
          prompt: promptText,
          status: `聞き取れませんでした（${attempt}回目）`,
          transcript: result.error || "-"
        });
        continue;
      }

      const value = resolveVoiceChoiceOrIndex(result.text, defs);
      if (!value) {
        setVoiceInputModalState({
          title: stageTitle,
          step: stepLabel,
          prompt: promptText,
          status: `候補に一致しません（${attempt}回目）`,
          transcript: result.text
        });
        continue;
      }

      if (!applySelection(value, result.text)) {
        setVoiceInputModalState({
          title: stageTitle,
          step: stepLabel,
          prompt: promptText,
          status: "反映に失敗しました。もう一度お願いします。",
          transcript: result.text
        });
        continue;
      }

      await waitMs(220);
      return { ok: true, value, rawText: result.text };
    }

    return { ok: false, cancelled: true };
  }

  async function captureVoiceAmount(stepLabel, promptText, targetInput, opts) {
    const o = opts || {};
    const stageTitle = String(o.title || "音声入力");
    const allowNone = !!o.allowNone;
    const showCash = !!o.showCash;
    const showCredit = !!o.showCredit;
    const activeField = o.activeField || "cash";
    let attempt = 0;

    setupVoiceStageModal(stageTitle, stepLabel, promptText, "数字を話してください。");

    while (!voiceFlowAbortRequested) {
      renderVoiceAmountBoxes({ showCash, showCredit, activeField });
      attempt += 1;
      setVoiceInputModalState({
        title: stageTitle,
        step: stepLabel,
        prompt: promptText,
        status: `金額をお話しください（${attempt}回目）`,
        transcript: "-"
      });

      const result = await recognizeSpeechOnceSilent(10000);
      if (voiceFlowAbortRequested) return { ok: false, cancelled: true };

      if (!result.ok) {
        setVoiceInputModalState({
          title: stageTitle,
          step: stepLabel,
          prompt: promptText,
          status: `聞き取れませんでした（${attempt}回目）`,
          transcript: result.error || "-"
        });
        continue;
      }

      const norm = normalizeVoiceText(result.text);
      const parsedDigits = extractVoiceDigits(result.text);
      if (allowNone && !parsedDigits && norm.includes("なし")) {
        targetInput.value = "";
        focused = targetInput;
        renderVoiceAmountBoxes({ showCash, showCredit, activeField });
        setVoiceInputModalState({ status: "なしとして反映しました。", transcript: result.text });
        await waitMs(220);
        return { ok: true, value: "", rawText: result.text };
      }

      let digits = parsedDigits;
      if (!digits && (norm === "ぜろ" || norm === "0" || norm === "れい" || norm === "まる")) digits = "0";
      if (!digits) {
        setVoiceInputModalState({
          title: stageTitle,
          step: stepLabel,
          prompt: promptText,
          status: `数字を認識できません（${attempt}回目）`,
          transcript: result.text
        });
        continue;
      }

      targetInput.value = digits;
      focused = targetInput;
      renderVoiceAmountBoxes({ showCash, showCredit, activeField });
      setVoiceInputModalState({ title: stageTitle, step: stepLabel, prompt: promptText, status: `${formatAmountText(digits)} を反映しました。`, transcript: result.text });
      await waitMs(220);
      return { ok: true, value: digits, rawText: result.text };
    }

    return { ok: false, cancelled: true };
  }

  async function captureVoiceNote(opts) {
    const o = opts || {};
    const stageTitle = String(o.title || "備考");
    const stepLabel = String(o.step || "備考");
    const promptText = String(o.prompt || "備考をお願いします。『なし』でも大丈夫です。");
    let attempt = 0;
    setupVoiceStageModal(stageTitle, stepLabel, promptText, "備考をお話しください。");

    while (!voiceFlowAbortRequested) {
      clearVoiceModalDynamic();
      attempt += 1;
      setVoiceInputModalState({
        title: stageTitle,
        step: stepLabel,
        prompt: promptText,
        status: `備考をお話しください（${attempt}回目）`,
        transcript: "-",
        hideTranscript: false
      });

      const result = await recognizeSpeechOnceSilent(10000);
      if (voiceFlowAbortRequested) return { ok: false, cancelled: true };

      if (!result.ok) {
        setVoiceInputModalState({ title: stageTitle, step: stepLabel, prompt: promptText, status: `聞き取れませんでした（${attempt}回目）`, transcript: result.error || "-", hideTranscript: false });
        continue;
      }

      const raw = String(result.text || "").trim();
      const norm = normalizeVoiceText(raw);
      inNote.value = (norm === "なし" || norm === "特になし") ? "" : raw;
      setVoiceInputModalState({ title: stageTitle, step: stepLabel, prompt: promptText, status: "備考を反映しました。", transcript: raw || "なし", hideTranscript: false });
      await waitMs(220);
      return { ok: true, value: inNote.value, rawText: raw };
    }

    return { ok: false, cancelled: true };
  }

  async function captureVoiceYesNo(stepLabel, promptText, opts) {
    const o = opts || {};

    if (o.useVoiceModal === false) {
      const attempts = Math.max(1, Number(o.attempts || 2));
      const timeoutMs = Math.max(3000, Number(o.timeoutMs || 9000));
      for (let attempt = 1; attempt <= attempts; attempt += 1) {
        const result = await recognizeSpeechOnceSilent(timeoutMs);
        if (voiceFlowAbortRequested) return { ok: false, cancelled: true };
        if (!result.ok) continue;

        const value = resolveVoiceChoiceOrIndex(result.text, VOICE_YES_NO_DEFS);
        if (!value) continue;
        return { ok: true, yes: value === "yes", rawText: result.text || "" };
      }
      return { ok: false, cancelled: false };
    }

    const res = await captureVoiceChoice(stepLabel, promptText, VOICE_YES_NO_DEFS, null, o);
    if (!res.ok) return { ok: false, cancelled: !!res.cancelled };
    return { ok: true, yes: res.value === "yes", rawText: res.rawText || "" };
  }

  async function runVoiceAmountStage() {
    if (state.payMethod === "現金") {
      inCredit.value = "";
      const cashRes = await captureVoiceAmount("4/8", "数字をお話しください。", inCash, {
        title: "金額入力",
        allowNone: false,
        showCash: true,
        showCredit: false,
        activeField: "cash"
      });
      if (!cashRes.ok) return cashRes;
      return { ok: true };
    }

    if (state.payMethod === "チケット他") {
      const cashRes = await captureVoiceAmount("4/8", "現収をお話しください。ない場合は『なし』。", inCash, {
        title: "現収入力",
        allowNone: true,
        showCash: true,
        showCredit: true,
        activeField: "cash"
      });
      if (!cashRes.ok) return cashRes;

      const creditRes = await captureVoiceAmount("5/8", "未収をお話しください。ない場合は『なし』。", inCredit, {
        title: "未収入力",
        allowNone: true,
        showCash: true,
        showCredit: true,
        activeField: "credit"
      });
      if (!creditRes.ok) return creditRes;

      return { ok: true };
    }

    inCash.value = "";
    const creditRes = await captureVoiceAmount("4/8", "数字をお話しください。", inCredit, {
      title: "金額入力",
      allowNone: false,
      showCash: false,
      showCredit: true,
      activeField: "credit"
    });
    if (!creditRes.ok) return creditRes;
    return { ok: true };
  }

  function getVoiceAmountVisibility() {
    if (state.payMethod === "現金") return { showCash: true, showCredit: false };
    if (state.payMethod === "チケット他") return { showCash: true, showCredit: true };
    return { showCash: false, showCredit: true };
  }

  function showVoiceAmountReviewModal() {
    return new Promise((resolve) => {
      let done = false;
      const finish = (payload) => {
        if (done) return;
        done = true;
        stopActiveVoiceRecognition();
        resolve(payload);
      };

      const vis = getVoiceAmountVisibility();
      setVoiceInputModalState({
        title: "金額確認",
        step: "6/8",
        prompt: "入力した金額を確認してください。",
        status: "修正する場合は「やり直し」を押してください。",
        transcript: "",
        hideTranscript: true,
        cancelText: "中止",
        retryText: "やり直し",
        okText: "OK",
        hideCancel: false,
        hideRetry: false,
        hideOk: false,
        singleAction: false,
        binaryAction: false
      });

      clearVoiceModalDynamic();
      appendVoiceAmountSnapshot(voiceInputModalDynamic, {
        showCash: vis.showCash,
        showCredit: vis.showCredit,
        guideText: "現在の入力金額"
      });

      if (voiceInputModalCancelBtn) {
        voiceInputModalCancelBtn.onclick = () => {
          voiceFlowAbortRequested = true;
          finish({ ok: false, cancelled: true });
        };
      }
      if (voiceInputModalRetryBtn) {
        voiceInputModalRetryBtn.onclick = () => finish({ ok: false, retry: true });
      }
      if (voiceInputModalOkBtn) {
        voiceInputModalOkBtn.onclick = () => finish({ ok: true });
      }
      if (voiceInputModalBg) {
        voiceInputModalBg.onclick = (e) => {
          if (e.target === voiceInputModalBg) {
            voiceFlowAbortRequested = true;
            finish({ ok: false, cancelled: true });
          }
        };
      }
      setVoiceModalEscHandler((e) => {
        if (e.key === "Escape") {
          voiceFlowAbortRequested = true;
          finish({ ok: false, cancelled: true });
        }
      });

      openVoiceInputModal();
      if (voiceInputModalOkBtn) voiceInputModalOkBtn.focus();

      (async () => {
        await waitMs(350);
        for (let attempt = 1; attempt <= 2; attempt += 1) {
          if (done || voiceFlowAbortRequested) return;
          setVoiceInputModalState({
            title: "金額確認",
            step: "6/8",
            prompt: "入力した金額を確認してください。",
            status: `「中止」「やり直し」「OK」を話してください（${attempt}回目）`,
            hideTranscript: true
          });

          const result = await recognizeSpeechOnceSilent(9000);
          if (done || voiceFlowAbortRequested) return;
          if (!result.ok) continue;

          const action = resolveVoiceChoiceOrIndex(result.text, VOICE_REVIEW_ACTION_DEFS);
          if (!action) {
            setVoiceInputModalState({
              title: "金額確認",
              step: "6/8",
              prompt: "入力した金額を確認してください。",
              status: "候補に一致しませんでした。ボタンでも操作できます。",
              transcript: result.text,
              hideTranscript: false
            });
            continue;
          }

          if (action === "cancel") {
            voiceFlowAbortRequested = true;
            finish({ ok: false, cancelled: true });
            return;
          }
          if (action === "retry") {
            finish({ ok: false, retry: true });
            return;
          }
          finish({ ok: true });
          return;
        }
      })().catch(() => {});
    });
  }

  async function startVoiceInputFlow() {
    if (!getSpeechRecognitionCtor()) {
      await showResultModal("この端末/ブラウザでは音声入力に対応していません。手動入力をご利用ください。");
      return;
    }

    voiceFlowAbortRequested = false;

    try {
      const rideRes = await captureVoiceChoice("1/8", "番号か項目をお話しください。", VOICE_RIDE_TYPE_DEFS, (value) => setGroupSelectionDirect("rideType", value), {
        title: "乗車種別を選択してください"
      });
      if (!rideRes.ok) throw new Error(rideRes.cancelled ? "cancelled" : "rideType");

      const payRes = await captureVoiceChoice("2/8", "番号か項目をお話しください。", VOICE_PAY_METHOD_DEFS, (value) => setGroupSelectionDirect("payMethod", value), {
        title: "支払方法を選択してください"
      });
      if (!payRes.ok) throw new Error(payRes.cancelled ? "cancelled" : "payMethod");

      if (state.payMethod === "チケット他") {
        const ticketRes = await captureVoiceChoice("3/8", "番号か項目をお話しください。", VOICE_TICKET_SUB_DEFS, (value) => setGroupSelectionDirect("ticketSub", value), {
          title: "チケット種別を選択してください"
        });
        if (!ticketRes.ok) throw new Error(ticketRes.cancelled ? "cancelled" : "ticketSub");
      }

      while (true) {
        const amountRes = await runVoiceAmountStage();
        if (!amountRes.ok) throw new Error(amountRes.cancelled ? "cancelled" : "amount");

        const hasCash = !!String(inCash.value || "").trim();
        const hasCredit = !!String(inCredit.value || "").trim();
        if (!hasCash && !hasCredit) {
          setVoiceInputModalState({ title: "金額入力", step: "6/8", prompt: "入力した金額を確認してください。", status: "現収または未収のどちらかを入力してください。", transcript: "-" });
          continue;
        }

        const reviewAns = await showVoiceAmountReviewModal();
        if (reviewAns.cancelled) throw new Error("cancelled");
        if (reviewAns.retry) {
          if (state.payMethod === "現金") inCash.value = "";
          else if (state.payMethod === "チケット他") {
            inCash.value = "";
            inCredit.value = "";
          } else {
            inCredit.value = "";
          }
          continue;
        }
        if (!reviewAns.ok) throw new Error("amount-confirm");
        break;
      }

      const noteRes = await captureVoiceNote({
        title: "備考入力",
        step: "7/8",
        prompt: "備考をお話しください。『なし』でも大丈夫です。"
      });
      if (!noteRes.ok) throw new Error(noteRes.cancelled ? "cancelled" : "note");

      closeVoiceInputModal();
      const submitOk = await showSubmitConfirmModal({ voice: true });
      if (!submitOk) {
        await showResultModal("登録確認でキャンセルしました。手動で修正してください。");
        return;
      }

      voiceSkipNextSubmitConfirm = true;
      voiceSubmitSuccessAutoRedirectSeconds = 5;
      btnSubmit.click();
    } catch (err) {
      closeVoiceInputModal();
      if (String(err && err.message) === "cancelled" || voiceFlowAbortRequested) {
        await showResultModal("音声入力を中止しました。手動入力をご利用ください。");
      } else {
        await showResultModal("音声入力で一部項目を認識できませんでした。手動入力に切り替えてください。");
      }
    } finally {
      voiceFlowAbortRequested = false;
      stopActiveVoiceRecognition();
      closeVoiceInputModal();
    }
  }

  btnDiscount.addEventListener("click", () => {
    state.disabilityDiscount = !state.disabilityDiscount;
    btnDiscount.classList.toggle("is-selected", state.disabilityDiscount);
  });

  document.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-group]");
    if (btn) {
      const g = btn.dataset.group;
      const v = btn.dataset.value || btn.textContent.trim();
      const selected = selectBtn(g, btn);

      if (g === "rideType") state.rideType = selected ? v : "";
      if (g === "payMethod") {
        state.payMethod = selected ? v : "";
        if (!selected) {
          state.ticketSub = "";
          clearSelected("ticketSub");
        }
        applyPayRules();
      }
      if (g === "ticketSub") state.ticketSub = selected ? v : "";

      if (selected) scrollToAmountsIfReady();
      return;
    }

    const keyBtn = e.target.closest("button[data-key]");
    if (!keyBtn || !focused) return;

    const k = keyBtn.dataset.key;
    const cur = String(focused.value || "");
    if (k === "back") focused.value = cur.slice(0, -1);
    else if (k === "00") focused.value = cur + "00";
    else if (/^[0-9]$/.test(k)) focused.value = cur + k;
    focused.focus();
  });

  [inCash, inCredit].forEach((inp) => {
    inp.addEventListener("focus", () => (focused = inp));
    inp.addEventListener("click", () => (focused = inp));
  });

  btnClear.addEventListener("click", async () => {
    if (!(await window.tsmsConfirm("入力内容をクリアしますか？"))) return;
    clearForm();
  });

  btnSubmit.addEventListener("click", async () => {
    if (!state.rideType || !state.payMethod) {
      alert("乗車種別と支払方法を選んでください");
      return;
    }

    const cash = (inCash.value || "").trim();
    const credit = (inCredit.value || "").trim();
    if (!cash && !credit) {
      alert("現収か未収のどちらかに金額を入力してください");
      return;
    }

    const skipSubmitConfirm = !!voiceSkipNextSubmitConfirm;
    const successAutoRedirectSeconds = Math.max(0, Number(voiceSubmitSuccessAutoRedirectSeconds || 5));
    voiceSkipNextSubmitConfirm = false;
    voiceSubmitSuccessAutoRedirectSeconds = 0;

    if (!skipSubmitConfirm && !(await showSubmitConfirmModal())) return;

    const now = new Date();
    const hh = String(now.getHours()).padStart(2, "0");
    const mm = String(now.getMinutes()).padStart(2, "0");

    const entry = {
      id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(16).slice(2)}`,
      time: `${hh}:${mm}`,
      ts: now.toISOString(),
      rideType: state.rideType,
      payMethod: state.payMethod,
      ticketSub: state.ticketSub || "",
      disabilityDiscount: !!state.disabilityDiscount,
      cash: cash ? Number(cash.replace(/[^0-9]/g, "")) : 0,
      credit: credit ? Number(credit.replace(/[^0-9]/g, "")) : 0,
      note: (inNote.value || "").trim(),
      dayId: resolveSaveDayId()
    };

    const params = new URLSearchParams(location.search);
    const editId = params.get("edit");

    let list = loadReports();

    if (editId) {
      const idx = list.findIndex((x) => x.id === editId);
      if (idx >= 0) {
        entry.id = editId;
        list[idx] = entry;
      } else {
        list.unshift(entry);
      }
    } else {
      list.unshift(entry);
    }

    try {
      localStorage.setItem(REPORT_KEY, JSON.stringify(list));
      localStorage.setItem(CURRENT_DAY_KEY, entry.dayId);
      localStorage.removeItem(CONFIRM_FORCE_EMPTY_KEY);
      if(window.tsmsCloud && typeof window.tsmsCloud.backupNow === "function"){
        try{
          await Promise.race([
            window.tsmsCloud.backupNow(),
            new Promise((resolve)=>setTimeout(resolve, 1200))
          ]);
        }catch(_){ }
      }
      await showResultModal("登録が完了しました", successAutoRedirectSeconds > 0 ? { autoCloseSeconds: successAutoRedirectSeconds, countdownLabel: "入力確認画面へ移動します" } : undefined);
      location.href = "confirm.html";
    } catch (e) {
      await showResultModal("登録が失敗しました。");
    }
  });

  (function loadForEdit() {
    const params = new URLSearchParams(location.search);
    const editId = params.get("edit");
    if (!editId) {
      applyPayRules();
      return;
    }

    let list = loadReports();
    const entry = list.find((x) => x.id === editId);
    if (!entry) {
      applyPayRules();
      return;
    }

    state.rideType = entry.rideType || "";
    state.payMethod = entry.payMethod || "";
    state.ticketSub = entry.ticketSub || "";
    state.disabilityDiscount = !!entry.disabilityDiscount;
    btnDiscount.classList.toggle("is-selected", state.disabilityDiscount);

    ["rideType", "payMethod", "ticketSub"].forEach((group) => {
      const target = state[group];
      if (!target) return;
      document.querySelectorAll(`button[data-group="${group}"]`).forEach((b) => {
        const v = b.dataset.value || b.textContent.trim();
        if (v === target) b.classList.add("is-selected");
      });
    });

    applyPayRules();
    inCash.value = entry.cash ? String(entry.cash) : "";
    inCredit.value = entry.credit ? String(entry.credit) : "";
    inNote.value = entry.note || "";
    focused = inCash;
    setTimeout(scrollToAmountsIfReady, 50);
  })();

  (function promptVoiceInputOnOpen() {
    setTimeout(async () => {
      if (document.visibilityState === "hidden") return;
      if (submitConfirmModalBg && submitConfirmModalBg.classList.contains("show")) return;
      const start = await showVoiceStartModal();
      if (!start) return;
      await startVoiceInputFlow();
    }, 250);
  })();
})();
</script>

<script>
(function(){
  const menu = document.getElementById("tsmsMenu");
  const bg = document.getElementById("tsmsMenuBg");
  const burger = document.getElementById("tsmsHamburger");
  if(!menu || !bg || !burger) return;

  function openMenu(){ menu.classList.add("open"); bg.classList.add("show"); }
  function closeMenu(){ menu.classList.remove("open"); bg.classList.remove("show"); }

  burger.addEventListener("click", openMenu);
  burger.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") openMenu(); });
  bg.addEventListener("click", closeMenu);
  menu.querySelectorAll("a").forEach((a)=>a.addEventListener("click", closeMenu));
})();
</script>

<script>
  (function(){if('serviceWorker' in navigator && location.protocol.indexOf('http')===0){window.addEventListener('load', function(){navigator.serviceWorker.register('./sw.js?v=20260228-1').catch(function(){});});}})();
</script>


<nav class="tsms-bottom-nav" aria-label="ボトムメニュー">
  <a href="report.html" data-tab="report"><span class="ico">📝</span><span>日報入力</span></a>
  <a href="confirm.html" data-tab="confirm"><span class="ico">✅</span><span>入力確認</span></a>
  <a href="detail.html" data-tab="detail"><span class="ico">📊</span><span>詳細確認</span></a>
  <a href="ops.html" data-tab="ops"><span class="ico">🚕</span><span>出庫/帰庫</span></a>
  <button type="button" id="tsmsMoreBtn"><span class="ico">⋯</span><span>その他</span></button>
</nav>
<div class="tsms-more-bg" id="tsmsMoreBg"></div>
<div class="tsms-more-sheet" id="tsmsMoreSheet" aria-label="その他メニュー">
  <a href="index.html">TOP</a>
  <a href="sales.html">月間管理</a>
  <a href="settings.html">設定</a>
</div>
<script>
(function(){
  var page=(location.pathname.split('/').pop()||'index.html').replace('.html','');
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    if(a.getAttribute('data-tab')===page) a.classList.add('active');
  });
  var iconMap={
    report:'<svg viewBox="0 0 24 24"><rect x="4" y="3" width="16" height="18" rx="2"/><path d="M8 8h8M8 12h8M8 16h5"/></svg>',
    confirm:'<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="m8 12 3 3 5-6"/></svg>',
    detail:'<svg viewBox="0 0 24 24"><path d="M4 19h16"/><rect x="6" y="10" width="3" height="6"/><rect x="11" y="7" width="3" height="9"/><rect x="16" y="5" width="3" height="11"/></svg>',
    ops:'<svg viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="8" rx="2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M6 8l2-3h8l2 3"/></svg>',
    more:'<svg viewBox="0 0 24 24"><circle cx="6" cy="7" r="1.5"/><circle cx="6" cy="12" r="1.5"/><circle cx="6" cy="17" r="1.5"/><path d="M10 7h10M10 12h10M10 17h10"/></svg>'
  };
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    var k=a.getAttribute('data-tab');
    var ico=a.querySelector('.ico');
    if(ico && iconMap[k]) ico.innerHTML=iconMap[k];
  });
  var moreIco=document.querySelector('#tsmsMoreBtn .ico');
  if(moreIco) moreIco.innerHTML=iconMap.more;
  var btn=document.getElementById('tsmsMoreBtn');
  var bg=document.getElementById('tsmsMoreBg');
  var sheet=document.getElementById('tsmsMoreSheet');
  function closeMore(){sheet.classList.remove('show');bg.classList.remove('show');}
  if(btn&&bg&&sheet){
    btn.addEventListener('click',function(){sheet.classList.add('show');bg.classList.add('show');});
    bg.addEventListener('click',closeMore);
  }
  var guard = page==='report';
  function isDirtyReport(){
    var cash=document.getElementById('in_cash');
    var credit=document.getElementById('in_credit');
    var note=document.getElementById('in_note');
    var discount=document.getElementById('btn_discount');
    var hasVal=((cash&&cash.value)||(credit&&credit.value)||(note&&note.value));
    var selected=document.querySelector('button[data-group].is-selected');
    var discountSelected=!!(discount&&discount.classList.contains('is-selected'));
    return !!(hasVal||selected||discountSelected);
  }
  document.querySelectorAll('.tsms-bottom-nav a, .tsms-more-sheet a').forEach(function(a){
    a.addEventListener('click',async function(e){
      if(guard && isDirtyReport()){
        e.preventDefault();
        var ok = await window.tsmsConfirm('入力を中止しますか？');
        if(!ok){
          closeMore();
          return;
        }
        closeMore();
        location.href = a.href;
        return;
      }
      closeMore();
    });
  });
})();
</script>

</body>
</html>
