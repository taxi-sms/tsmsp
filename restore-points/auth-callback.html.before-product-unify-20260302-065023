<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>認証コールバック</title>
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <meta name="theme-color" content="#ffffff">
  <script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="./tsms-design.css?v=20260227-3">
  <style id="auth-callback-layout-tweaks">
    main.auth-main{
      max-width:720px;
      min-height:calc(100dvh - var(--header-h));
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:var(--space-2);
    }
    .auth-card{
      border:var(--line-regular) solid var(--border)!important;
      background:var(--surface-1)!important;
      border-radius:var(--radius-md);
      padding:var(--space-3)!important;
      margin:0!important;
      box-shadow:var(--shadow-sm);
    }
    .auth-title{
      margin:0 0 var(--space-2);
      font-size:var(--font-2xl);
      font-weight:900;
      line-height:1.35;
      color:var(--text-primary);
      letter-spacing:0;
      text-transform:none;
    }
    .auth-note{
      font-size:var(--font-sm);
      color:var(--text-muted);
      line-height:1.45;
      margin:0;
    }
    .auth-status{
      margin-top:var(--space-3);
      border:var(--line-regular) solid var(--border);
      background:var(--surface-2);
      border-radius:var(--radius-sm);
      padding:var(--space-3);
      white-space:pre-wrap;
      font-size:var(--font-lg);
      line-height:1.45;
      min-height:44px;
    }
    .auth-actions{
      display:flex;
      gap:var(--space-2);
      margin-top:var(--space-3);
      flex-wrap:wrap;
    }
    .auth-actions .btn{min-width:160px;}
  </style>
</head>
<body>
<header class="header">認証コールバック</header>
<main class="main auth-main">
  <section class="auth-card">
    <div class="auth-title">メールリンク確認中</div>
    <p class="auth-note">認証メールのリンクから戻ってきた際の受け口ページです。完了後にログインページへ戻ってください。</p>
    <div class="auth-status" id="status">処理中...</div>
    <div class="auth-actions">
      <a class="btn" href="index.html">TOPへ</a>
      <a class="btn next" href="login.html">ログインページへ</a>
    </div>
  </section>
</main>

<script>
(async function(){
  const statusEl = document.getElementById("status");
  function setStatus(text){ statusEl.textContent = text; }

  const CONFIG_KEY = "tsms_supabase_config";
  const FALLBACK_URL = "https://gsvehqeywmjqlvuzwvuo.supabase.co";
  const FALLBACK_ANON_KEY = "sb_publishable_PCpsmoo77V5L0YQfT2yKnA_QCEFpARJ";

  function readConfig(){
    try{
      const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || "null") || {};
      return {
        url: String(cfg.url || "").trim() || FALLBACK_URL,
        anonKey: String(cfg.anonKey || "").trim() || FALLBACK_ANON_KEY
      };
    }catch(_){
      return { url: FALLBACK_URL, anonKey: FALLBACK_ANON_KEY };
    }
  }

  const cfg = readConfig();
  if(!window.supabase || !window.supabase.createClient){
    setStatus("Supabase SDKの読み込みに失敗しました。");
    return;
  }
  if(!cfg.url || !cfg.anonKey){
    setStatus("Supabase設定が未完了です。settings.html で URL / Anon Key を設定してください。");
    return;
  }

  const supabase = window.supabase.createClient(cfg.url, cfg.anonKey);

  try{
    const url = new URL(location.href);
    const hasCode = !!url.searchParams.get("code");

    if(hasCode){
      const { error } = await supabase.auth.exchangeCodeForSession(location.href);
      if(error) throw error;
    }else if(location.hash.includes("access_token=")){
      const hash = new URLSearchParams(location.hash.replace(/^#/, ""));
      const access_token = hash.get("access_token");
      const refresh_token = hash.get("refresh_token");
      if(access_token && refresh_token){
        const { error } = await supabase.auth.setSession({ access_token, refresh_token });
        if(error) throw error;
      }
    }

    const { data, error } = await supabase.auth.getSession();
    if(error) throw error;
    if(data.session){
      setStatus("認証完了\nログイン中: " + data.session.user.email + "\nこのままログインページまたはTOPへ戻れます。");
    }else{
      setStatus("認証リンクは処理されましたが、セッションを確認できませんでした。\nもう一度ログインをお試しください。");
    }
  }catch(err){
    setStatus("認証処理に失敗しました:\n" + (err && err.message ? err.message : String(err)));
  }
})();
</script>
  <script src="./cache-version.js"></script>
</body>
</html>
