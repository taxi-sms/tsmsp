<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width,
               initial-scale=1,
               maximum-scale=1,
               user-scalable=no"/>
  <title>詳細確認</title>
    <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
<style>
    :root{ --bg:#fff; --text:#111; --muted:#666; --border:#999; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:"Noto Sans JP", sans-serif;
      font-size:18px;
    }
    .main{padding:12px;}
    .note{font-size:13px;color:var(--muted);line-height:1.35;margin:8px 0;}
    .main .section{
      border:0 !important;
      background:transparent !important;
      margin:8px 0;
      padding:4px 0 2px;
    }
    .title{
      display:flex;align-items:center;gap:10px;
      font-weight:900;font-size:22px;margin:0 0 8px 0;
    }
    .title::after{
      content:"";
      flex:1 1 auto;
      border-top:2px solid var(--border);
      opacity:.95;
    }
    .main .box{
      border:0 !important;
      background:transparent !important;
      padding:0;
    }
    .line{display:flex;gap:10px;padding:6px 0;border-bottom:none;align-items:flex-start;}
    .line:last-child{border-bottom:none;}
    .k{width:160px;font-weight:800;}
    .v{margin-left:auto;font-weight:800;text-align:right;white-space:nowrap;}
    .v.value-highlight{color:#FD7E00;font-weight:900;}
    .line.strong .k,
    .line.strong .v{font-weight:900;}
    .date-switcher{
      border:0 !important;
      background:transparent !important;
      padding:0 !important;
      margin:0 0 8px 0;
    }
    .date-switcher label{display:none !important;}
    .date-switcher select{width:100%;box-sizing:border-box;border:2px solid var(--border);background:var(--surface-2);padding:10px;font-size:16px;color:var(--text-primary);}

/* ---- TSMS Hamburger Menu (overlay) ---- */
.tsms-header{
  position:sticky; top:0; z-index:100;
  height:60px; background:#fff;
  border-bottom:2px solid #000;
  display:flex; align-items:center;
  padding:0 14px 0 56px;
  font-weight:900; font-size:20px;
}
.header-to-report{
  margin-left:auto;
  border:2px solid #000;
  padding:6px 10px;
  font-size:14px;
  font-weight:900;
  color:#000;
  text-decoration:none;
  line-height:1.2;
  background:#fff;
}
.tsms-hamburger{
  position:absolute; left:14px; top:50%;
  transform:translateY(-50%);
  width:32px; height:24px;
  display:flex; flex-direction:column; justify-content:space-between;
  cursor:pointer; user-select:none;
}
.tsms-hamburger span{ height:3px; background:#000; display:block; }
.tsms-menu{
  position:fixed; top:0; left:0; height:100%; width:280px;
  background:#fff; border-right:2px solid #000;
  transform:translateX(-100%);
  transition:transform .25s ease;
  z-index:1000; padding-top:60px;
}
.tsms-menu.open{ transform:translateX(0); }
.tsms-menu a{
  display:block; padding:16px;
  border-bottom:1px solid #ddd;
  text-decoration:none; color:#000;
  font-size:18px; font-weight:900;
}
.tsms-menu small{ display:block; margin-top:2px; font-size:12px; font-weight:700; color:#666; }
.tsms-menu-bg{
  position:fixed; inset:0;
  background:rgba(0,0,0,.25);
  opacity:0; pointer-events:none;
  transition:opacity .2s ease;
  z-index:900;
}
.tsms-menu-bg.show{ opacity:1; pointer-events:auto; }
/* -------------------------------------- */
/* ---- Theme tokens ---- */
:root{
  --bg:#F3F6F8;
  --surface-1:#FFFFFF;
  --surface-2:#EEF3F6;
  --border:#D5DEE6;
  --text-primary:#0F1720;
  --text-secondary:#344554;
  --text-muted:#5B6D7C;
  --accent:#2580ED;
  --accent-hover:#4DA3FF;
  --link:#187FBF;
}
:root[data-theme="dark"]{
  --bg:#0F1417;
  --surface-1:#151C20;
  --surface-2:#1B242A;
  --border:#2A353D;
  --text-primary:#E6EEF3;
  --text-secondary:#B7C4CC;
  --text-muted:#8A949A;
  --accent:#3B95F0;
  --accent-hover:#4DA3FF;
  --link:#58C2FF;
}
html,body{ background:var(--bg)!important; color:var(--text-primary)!important; }
a{ color:var(--link); }
.tsms-header,.header,.app-header,.card,.wf-panel,.section,.date-switcher,.menu,.tsms-menu,.box{background:var(--surface-1)!important;border-color:var(--border)!important;color:var(--text-primary)!important;}
.note,.wf-field-label,.label,.k,.idx,.desc,.wf-subnote,.wf-field-label{color:var(--text-muted)!important;}
.tsms-menu a,.menu a,.header-to-report,.btn,.actionBtn,.key,.input,select,.key.small{background:var(--surface-2)!important;color:var(--text-primary)!important;border-color:var(--border)!important;}
.menu small,.tsms-menu small{color:var(--text-muted)!important;}
.btn.next{background:var(--accent)!important;border-color:var(--accent)!important;color:#fff!important;}
.menu-bg,.tsms-menu-bg{background:rgba(15,23,32,.35)!important;}

.hamburger span,.tsms-hamburger span{background:#58C2FF!important;}
/* ---- Theme tokens end ---- */

</style>
<link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TSMS">
  <script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>

<style id="tsms-bottom-nav-style">
  body{padding-bottom:78px;}
  .tsms-hamburger,.hamburger,.tsms-menu,.menu,.tsms-menu-bg,.menu-bg{display:none!important;}
  .tsms-header,.header{padding-left:14px!important;}
  .tsms-bottom-nav{position:fixed;left:0;right:0;bottom:0;z-index:1200;display:grid;grid-template-columns:repeat(5,1fr);background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);padding-bottom:env(safe-area-inset-bottom);}
  .tsms-bottom-nav a,.tsms-bottom-nav button{appearance:none;border:0;background:transparent;color:var(--text-secondary,#445);font:inherit;font-size:11px;font-weight:900;padding:8px 2px 9px;min-height:58px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;text-decoration:none;}
  .tsms-bottom-nav .active{color:var(--text-primary,#111);position:relative;}
  .tsms-bottom-nav .active::before{content:"";position:absolute;top:0;left:14%;right:14%;height:2px;background:#58C2FF;}
  .tsms-more-sheet{position:fixed;left:0;right:0;bottom:0;z-index:1300;background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);transform:translateY(110%);transition:transform .2s ease;padding:12px 12px calc(12px + env(safe-area-inset-bottom));}
  .tsms-more-sheet.show{transform:translateY(0);}
  .tsms-more-sheet a{display:block;padding:12px;border:2px solid var(--border,#ccc);margin-top:8px;text-decoration:none;color:var(--text-primary,#111);background:var(--surface-2,#f5f5f5);font-weight:900;}
  .tsms-more-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;z-index:1250;transition:opacity .2s;}
  .tsms-more-bg.show{opacity:1;pointer-events:auto;}
</style>

  <script type="module" src="auth-guard.js?v=20260223-5"></script>
  <script src="./custom-confirm.js"></script>
</head>
<body>
<nav class="tsms-menu" id="tsmsMenu" aria-label="サイドメニュー">
  <a href="index.html">TOP<small>メニュー一覧</small></a>
  <a href="report.html">日報入力<small>乗車データを入力</small></a>
  <a href="confirm.html">入力確認<small>当日・過去のデータを確認</small></a>
  <a href="detail.html">詳細確認<small>概算手取、集計結果など</small></a>
  <a href="ops.html">出庫 / 帰庫 / 休憩<small>休憩タイマーなど</small></a>
  <a href="sales.html">月間管理<small>当月、過去の売上確認</small></a>
  <a href="settings.html">設定<small>歩率、締め期間、シフトなど</small></a>
</nav>
<div class="tsms-menu-bg" id="tsmsMenuBg" aria-hidden="true"></div>

<header class="tsms-header">
  <div class="tsms-hamburger" id="tsmsHamburger" role="button" tabindex="0" aria-label="メニュー"><span></span><span></span><span></span></div>
  詳細確認
  <a class="header-to-report" href="report.html">入力画面へ</a>
</header>

<main class="main">
  <section class="date-switcher">
    <select id="detailDateSelect" aria-label="表示日付"></select>
  </section>

  <section class="section">
    <div class="title">時間関連</div>
    <div class="box" id="timeBox"></div>
  </section>

  <section class="section">
    <div class="title">売上関連</div>
    <div class="box" id="salesBox"></div>
  </section>

  <section class="section">
    <div class="title">GO関連</div>
    <div class="box" id="goBox"></div>
  </section>
</main>

<script>
(function(){
  const REPORT_KEY = "tsms_reports";
  const REPORT_ARCHIVE_KEY = "tsms_reports_archive";
  const OPS_KEY = "ops";
  const OPS_ARCHIVE_KEY = "ops_archive_v1";
  const DAY_KEY = "tsms_report_current_day";
  const CONFIRM_FORCE_EMPTY_KEY = "tsms_confirm_force_empty";
  const SETTINGS_KEY = "tsms_settings";
  let selectedDayId = "";

  function loadJson(key, fallback){
    try{
      const v = JSON.parse(localStorage.getItem(key) || "null");
      return (v === null ? fallback : v);
    }catch(_){ return fallback; }
  }
  function localYmd(d=new Date()){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }
  function rowDayId(r){
    if(r && r.dayId) return String(r.dayId);
    if(r && r.ts){
      const d = new Date(r.ts);
      if(!isNaN(d)) return localYmd(d);
    }
    return "";
  }
  function num(v){ return Number(v||0); }
  function yen(v){ return `${Math.round(num(v)).toLocaleString("ja-JP")}円`; }
  function fmtDateTime(d){
    return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
  }
  function fmtIso(iso){
    if(!iso) return "--";
    const d = new Date(iso);
    if(isNaN(d)) return "--";
    return fmtDateTime(d);
  }
  function fmtMinutes(min){
    const m = Math.max(0, Math.round(num(min)));
    const h = Math.floor(m/60);
    const mm = m%60;
    return `${h}時間${String(mm).padStart(2,"0")}分`;
  }
  function line(label, value, strong=false, highlightValue=false){
    return `<div class="line${strong ? " strong" : ""}"><div class="k">${label}</div><div class="v${highlightValue ? " value-highlight" : ""}">${value}</div></div>`;
  }

  function loadReportsAll(){
    const active = loadJson(REPORT_KEY, []);
    const archived = loadJson(REPORT_ARCHIVE_KEY, []);
    const a = Array.isArray(active) ? active : [];
    const b = Array.isArray(archived) ? archived : [];
    return a.concat(b);
  }

  function loadOpsByDayId(dayId){
    const current = loadJson(OPS_KEY, {});
    const target = String(dayId || "");
    const currentDay = String((current && (current.dayId || current.date)) || "");
    if(current && currentDay === target) return current;
    const archive = loadJson(OPS_ARCHIVE_KEY, {});
    if(archive && typeof archive === "object"){
      if(archive[target]) return archive[target];
      const list = Object.values(archive);
      for(const item of list){
        if(!item || typeof item !== "object") continue;
        const d = String(item.dayId || item.date || "");
        if(d === target) return item;
      }
    }
    return {};
  }

  function hasOpsData(ops){
    if(!ops || typeof ops !== "object") return false;
    return !!(ops.departAt || ops.returnAt || (Array.isArray(ops.breakSessions) && ops.breakSessions.length));
  }

  function availableDays(){
    const days = new Set();
    loadReportsAll().forEach((r)=>{
      const d = rowDayId(r);
      if(d) days.add(d);
    });
    const opsCurrent = loadJson(OPS_KEY, {});
    if(hasOpsData(opsCurrent)){
      const d = String(opsCurrent.dayId || "");
      if(d) days.add(d);
    }
    const opsArchive = loadJson(OPS_ARCHIVE_KEY, {});
    if(opsArchive && typeof opsArchive === "object"){
      Object.keys(opsArchive).forEach((k)=>{ if(k) days.add(String(k)); });
    }
    return Array.from(days).sort((a,b)=> b.localeCompare(a));
  }

  function syncDateSelect(){
    const sel = document.getElementById("detailDateSelect");
    if(!sel) return;
    const days = availableDays();
    const currentDay = localStorage.getItem(DAY_KEY) || "";
    const forceEmpty = localStorage.getItem(CONFIRM_FORCE_EMPTY_KEY) === "1";
    const today = localYmd();

    sel.innerHTML = "";
    const emptyOpt = document.createElement("option");
    emptyOpt.value = "";
    emptyOpt.textContent = "日付を選択";
    sel.appendChild(emptyOpt);
    days.forEach((dayId)=>{
      const opt = document.createElement("option");
      opt.value = dayId;
      opt.textContent = dayId.replace(/-/g, "/");
      sel.appendChild(opt);
    });

    let next = "";
    if(!forceEmpty && currentDay && days.includes(currentDay)){
      next = currentDay;
    }else if(selectedDayId && days.includes(selectedDayId)){
      next = selectedDayId;
    }else if(!forceEmpty && days.includes(today)){
      next = today;
    }else if(!forceEmpty && days.length){
      next = days[0];
    }
    selectedDayId = next;
    sel.value = next;
  }

  function render(){
    const now = new Date();
    const dayId = selectedDayId;
    const ops = loadOpsByDayId(dayId);
    const reports = loadReportsAll();
    const settings = Object.assign({ taxRate:10, feeRate:4, goFeeYen:100, walkRate:50 }, loadJson(SETTINGS_KEY, {}));

    const departAt = ops.departAt || null;
    const returnAt = ops.returnAt || null;
    const departMs = departAt ? new Date(departAt).getTime() : NaN;
    const endMs = returnAt ? new Date(returnAt).getTime() : Date.now();
    const elapsedMin = isNaN(departMs) ? 0 : Math.max(0, Math.round((endMs - departMs)/60000));

    const sess = Array.isArray(ops.breakSessions) ? ops.breakSessions : [];
    let breakMin = sess.reduce((s,x)=> s + num(x.minutes), 0);
    if(ops.breakActive && ops.breakStartAt){
      const bms = new Date(ops.breakStartAt).getTime();
      if(!isNaN(bms)) breakMin += Math.max(0, Math.round((Date.now()-bms)/60000));
    }
    const workMin = Math.max(0, elapsedMin - breakMin);

    const rows = dayId ? reports.filter((r) => rowDayId(r) === dayId) : [];
    const tripCount = rows.length;
    const cashSum = rows.reduce((s,r)=> s + num(r.cash), 0);
    const creditSum = rows.reduce((s,r)=> s + num(r.credit), 0);
    const grossBase = cashSum + creditSum;

    const feeBase = rows.filter(r => ["クレカ","QR","電子M"].includes(String(r.payMethod||""))).reduce((s,r)=> s + num(r.cash) + num(r.credit), 0);
    const fee = feeBase * (num(settings.feeRate)/100);

    const goCases = rows.filter(r => String(r.rideType||"") === "GO").length;
    const goPayCount = rows.filter(r => ["GO pay","GO Pay","乗込GO Pay"].includes(String(r.payMethod||""))).length;
    const norikomiGoPayCount = rows.filter(r => String(r.payMethod||"") === "乗込GO Pay").length;
    const goAmount = rows.filter(r => ["GO pay","GO Pay","乗込GO Pay"].includes(String(r.payMethod||""))).reduce((s,r)=> s + num(r.cash) + num(r.credit), 0);
    const goFeeCases = rows.filter(r => String(r.rideType||"")==="GO" && !["GO pay","GO Pay","乗込GO Pay"].includes(String(r.payMethod||""))).length;
    const goFeeTotal = goFeeCases * num(settings.goFeeYen);

    const salesInTax = grossBase - fee - goFeeTotal;
    const salesExTax = salesInTax / (1 + num(settings.taxRate)/100);
    const takeHome = salesExTax * (num(settings.walkRate)/100);
    const hourly = workMin > 0 ? (takeHome / (workMin/60)) : 0;

    document.getElementById("timeBox").innerHTML = [
      line("現在時刻", fmtDateTime(now)),
      line("出庫時間", fmtIso(departAt)),
      line("経過時間", fmtMinutes(elapsedMin)),
      line("休憩時間", fmtMinutes(breakMin)),
      line("実働時間", fmtMinutes(workMin), true)
    ].join("");

    document.getElementById("salesBox").innerHTML = [
      line("実車回数", `${tripCount}回`),
      line("現収合計", yen(cashSum)),
      line("未収合計", yen(creditSum)),
      line("売上合計（税込）", yen(salesInTax), true, true),
      line("売上合計（税抜）", yen(salesExTax)),
      line("決済手数料", yen(fee)),
      line("概算収入", yen(takeHome), true, true),
      line("時給換算", yen(hourly), false, true)
    ].join("");

    document.getElementById("goBox").innerHTML = [
      line("GO予約数", `${goCases}回`),
      line("GO手配料", yen(goFeeTotal)),
      line("GO Pay件数", `${goPayCount}件`),
      line("（内、乗込GO Pay）", `${norikomiGoPayCount}件`),
      line("GO計金額", yen(goAmount))
    ].join("");
  }

  const sel = document.getElementById("detailDateSelect");
  if(sel){
    sel.addEventListener("change", ()=>{
      selectedDayId = sel.value || "";
      if(selectedDayId){
        localStorage.setItem(DAY_KEY, selectedDayId);
        localStorage.removeItem(CONFIRM_FORCE_EMPTY_KEY);
      }else{
        localStorage.removeItem(DAY_KEY);
      }
      render();
    });
  }

  syncDateSelect();
  render();
  setInterval(render, 1000);
})();
</script>

<script>
(function(){
  const menu = document.getElementById("tsmsMenu");
  const bg = document.getElementById("tsmsMenuBg");
  const burger = document.getElementById("tsmsHamburger");
  if(!menu || !bg || !burger) return;
  function openMenu(){ menu.classList.add("open"); bg.classList.add("show"); }
  function closeMenu(){ menu.classList.remove("open"); bg.classList.remove("show"); }
  burger.addEventListener("click", openMenu);
  burger.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" ") openMenu(); });
  bg.addEventListener("click", closeMenu);
  menu.querySelectorAll("a").forEach((a)=>a.addEventListener("click", closeMenu));
})();
</script>

<script>
  (function(){if('serviceWorker' in navigator && location.protocol.indexOf('http')===0){window.addEventListener('load', function(){navigator.serviceWorker.register('./sw.js?v=20260223-16').catch(function(){});});}})();
</script>

<nav class="tsms-bottom-nav" aria-label="ボトムメニュー">
  <a href="report.html" data-tab="report"><span>日報入力</span></a>
  <a href="confirm.html" data-tab="confirm"><span>入力確認</span></a>
  <a href="detail.html" data-tab="detail"><span>詳細確認</span></a>
  <a href="ops.html" data-tab="ops"><span>出庫/帰庫</span></a>
  <button type="button" id="tsmsMoreBtn"><span>その他</span></button>
</nav>
<div class="tsms-more-bg" id="tsmsMoreBg"></div>
<div class="tsms-more-sheet" id="tsmsMoreSheet" aria-label="その他メニュー">
  <a href="index.html">TOP</a>
  <a href="sales.html">月間管理</a>
  <a href="settings.html">設定</a>
</div>
<script>
(function(){
  var page=(location.pathname.split('/').pop()||'index.html').replace('.html','');
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    if(a.getAttribute('data-tab')===page) a.classList.add('active');
  });  var btn=document.getElementById('tsmsMoreBtn');
  var bg=document.getElementById('tsmsMoreBg');
  var sheet=document.getElementById('tsmsMoreSheet');
  function closeMore(){sheet.classList.remove('show');bg.classList.remove('show');}
  if(btn&&bg&&sheet){
    btn.addEventListener('click',function(){sheet.classList.add('show');bg.classList.add('show');});
    bg.addEventListener('click',closeMore);
  }
  var guard = page==='report';
  function isDirtyReport(){
    var cash=document.getElementById('in_cash');
    var credit=document.getElementById('in_credit');
    var note=document.getElementById('in_note');
    var hasVal=((cash&&cash.value)||(credit&&credit.value)||(note&&note.value));
    var selected=document.querySelector('button[data-group].is-selected');
    return !!(hasVal||selected);
  }
  document.querySelectorAll('.tsms-bottom-nav a, .tsms-more-sheet a').forEach(function(a){
    a.addEventListener('click',async function(e){
      if(guard && isDirtyReport() && !(await window.tsmsConfirm('入力を中止しますか？'))){
        e.preventDefault();
      }
      closeMore();
    });
  });
})();
</script>

  <script src="./cache-version.js"></script>
</body>
</html>
