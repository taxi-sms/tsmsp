<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width,
               initial-scale=1,
               maximum-scale=1,
               user-scalable=no"/>
<title>出庫 / 帰庫 / 休憩</title>
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
<style>
:root{ --border:#888; --muted:#666; }

html,body{
  margin:0; padding:0; background:#fff; color:#111;
  font-family:"Noto Sans JP", sans-serif;
  font-size:18px;
}

/* Header */
.header{
  position:relative;
  border-bottom:2px solid var(--border);
  padding:14px 14px 14px 56px;
  font-size:20px;
  font-weight:900;
}
.header-to-report{
  margin-left:auto;
  border:2px solid #000;
  padding:6px 10px;
  font-size:14px;
  font-weight:900;
  color:#000;
  text-decoration:none;
  line-height:1.2;
  background:#fff;
}
/* Hamburger */
.hamburger{
  position:absolute; left:14px; top:50%;
  transform:translateY(-50%);
  width:32px; height:24px;
  cursor:pointer;
  display:flex; flex-direction:column; justify-content:space-between;
}
.hamburger span{ display:block; height:3px; background:#111; }

/* Overlay menu */
.menu{
  position:fixed; top:0; left:0;
  width:280px; height:100%;
  background:#fff;
  border-right:2px solid var(--border);
  transform:translateX(-100%);
  transition:transform .25s ease;
  z-index:1000;
  padding-top:60px;
}
.menu.open{ transform:translateX(0); }
.menu a{
  display:block; padding:16px;
  border-bottom:1px solid #ddd;
  text-decoration:none; color:#111;
  font-size:18px; font-weight:700;
}
.menu small{ display:block; margin-top:2px; font-size:12px; font-weight:700; color:#666; }
.menu-bg{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.25);
  opacity:0; pointer-events:none;
  transition:opacity .2s;
  z-index:900;
}
.menu-bg.show{ opacity:1; pointer-events:auto; }

/* Content */
.main{ padding:12px; max-width:1000px; margin:0 auto; }
.main .card{
  border:0 !important;
  background:transparent !important;
  padding:4px 0 2px;
  margin:8px 0;
}

.note{ font-size:12px; color:var(--muted); margin:0 0 10px 0; line-height:1.35; }

.group-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:900;
  font-size:16px;
  margin:0 0 8px 0;
}
.group-title::after{
  content:"";
  flex:1 1 auto;
  border-top:2px solid var(--border);
  opacity:.95;
}

/* Rows (no inner boxes) */
.content{ display:grid; gap:0; }
.line{ display:flex; gap:10px; align-items:baseline; padding:6px 0; border-bottom:none; }
.content .line:last-child{ border-bottom:none; }
.k{ width:130px; font-size:12px; color:var(--muted); }
.v{ font-size:20px; font-weight:900; margin-left:auto; font-variant-numeric:tabular-nums; }

.actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px; }
.btn{
  border:2px solid var(--border);
  background:#fff;
  border-radius:0;
  padding:16px 10px;
  font-size:18px;
  font-weight:900;
  min-height:64px;
}
.btn.action-main{ min-height:128px; }
.btn.small{ font-size:14px; min-height:52px; padding:12px 10px; font-weight:800; }
.btn.reset-final{ min-height:124px; line-height:1.3; }
.btn.reset-final .warn{ display:block; color:#c00; font-size:13px; font-weight:900; margin-top:6px; }
.btn.wide{ grid-column:1 / -1; }
.btn.danger{ border-color:#333; }
.btn:disabled{ opacity:.45; }
.btn.btn-mini{
  min-height:auto;
  padding:6px 10px;
  font-size:12px;
  font-weight:800;
  border-width:1px;
}
.btn.next{
  background:#111;
  color:#fff;
  border-color:#111;
}

.pill{ border:2px solid var(--border); padding:4px 8px; font-size:12px; font-weight:800; display:inline-block; }

.result-modal-bg{
  position:fixed; inset:0; z-index:1400;
  background:rgba(0,0,0,.45);
  display:none; align-items:center; justify-content:center;
  padding:16px;
}
.result-modal-bg.show{ display:flex; }
.result-modal-card{
  width:min(320px,100%);
  background:var(--surface-1,#fff);
  border:2px solid var(--border,#ccc);
  padding:18px 14px 14px;
  text-align:center;
}
.result-modal-icon{
  width:56px; height:56px; margin:0 auto 12px;
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  color:#fff; font-size:28px; font-weight:900; line-height:1;
}
.result-modal-icon.success{ background:#1ea44a; }
.result-modal-icon.error{ background:#d93025; }
.result-modal-message{ margin:0 0 14px; font-size:18px; font-weight:900; line-height:1.4; }
.result-modal-actions{ display:grid; grid-template-columns:1fr; gap:8px; }

/* Break sessions list */
.list{ margin-top:10px; }
.bottom-mini-actions{ margin-top:10px; display:flex; justify-content:flex-end; }
.sync-meta{
  margin-top:10px;
  font-size:12px;
  color:var(--text-muted,#666);
  text-align:right;
  line-height:1.35;
}
.sync-meta.error{ color:#c62828; font-weight:700; }
.item{ display:flex; gap:10px; align-items:baseline; padding:6px 0; border-bottom:none; }
.item:last-child{ border-bottom:none; }
.item .idx{ width:36px; color:var(--muted); font-size:12px; }
.item .txt{ font-size:14px; font-weight:800; }
.item .dur{ margin-left:auto; font-size:14px; font-weight:900; font-variant-numeric:tabular-nums; }

@media (max-width:420px){
  .k{ width:110px; }
  .v{ font-size:18px; }
  .btn{ font-size:16px; min-height:58px; }
  .btn.action-main{ min-height:116px; }
}
@media (min-width:768px){
  .k{ width:160px; }
  .v{ font-size:22px; }
  .actions{ grid-template-columns:1fr 1fr 1fr 1fr; }
  .btn.wide{ grid-column:auto; }
}
/* ---- Theme tokens ---- */
:root{
  --bg:#F3F6F8;
  --surface-1:#FFFFFF;
  --surface-2:#EEF3F6;
  --border:#D5DEE6;
  --text-primary:#0F1720;
  --text-secondary:#344554;
  --text-muted:#5B6D7C;
  --accent:#2580ED;
  --accent-hover:#4DA3FF;
  --link:#187FBF;
}
:root[data-theme="dark"]{
  --bg:#0F1417;
  --surface-1:#151C20;
  --surface-2:#1B242A;
  --border:#2A353D;
  --text-primary:#E6EEF3;
  --text-secondary:#B7C4CC;
  --text-muted:#8A949A;
  --accent:#3B95F0;
  --accent-hover:#4DA3FF;
  --link:#58C2FF;
}
html,body{ background:var(--bg)!important; color:var(--text-primary)!important; }
a{ color:var(--link); }
.tsms-header,.header,.app-header,.card,.wf-panel,.section,.date-switcher,.menu,.tsms-menu,.box{background:var(--surface-1)!important;border-color:var(--border)!important;color:var(--text-primary)!important;}
.note,.wf-field-label,.label,.k,.idx,.desc,.wf-subnote,.wf-field-label{color:var(--text-muted)!important;}
.tsms-menu a,.menu a,.header-to-report,.btn,.actionBtn,.key,.input,select,.key.small{background:var(--surface-2)!important;color:var(--text-primary)!important;border-color:var(--border)!important;}
.menu small,.tsms-menu small{color:var(--text-muted)!important;}
.btn.next{background:var(--accent)!important;border-color:var(--accent)!important;color:#fff!important;}
.menu-bg,.tsms-menu-bg{background:rgba(15,23,32,.35)!important;}

.hamburger span,.tsms-hamburger span{background:#58C2FF!important;}
/* ---- Theme tokens end ---- */

</style>
<link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TSMS">

  <script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>

<style id="tsms-bottom-nav-style">
  body{padding-bottom:78px;}
  .tsms-hamburger,.hamburger,.tsms-menu,.menu,.tsms-menu-bg,.menu-bg{display:none!important;}
  .tsms-header,.header{padding-left:14px!important;}
  .tsms-bottom-nav{position:fixed;left:0;right:0;bottom:0;z-index:1200;display:grid;grid-template-columns:repeat(5,1fr);background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);padding-bottom:env(safe-area-inset-bottom);}
  .tsms-bottom-nav a,.tsms-bottom-nav button{appearance:none;border:0;background:transparent;color:var(--text-secondary,#445);font:inherit;font-size:11px;font-weight:900;padding:8px 2px 9px;min-height:58px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;text-decoration:none;}
  .tsms-bottom-nav .active{color:var(--text-primary,#111);position:relative;}
  .tsms-bottom-nav .active::before{content:"";position:absolute;top:0;left:14%;right:14%;height:2px;background:#58C2FF;}
  .tsms-more-sheet{position:fixed;left:0;right:0;bottom:0;z-index:1300;background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);transform:translateY(110%);transition:transform .2s ease;padding:12px 12px calc(12px + env(safe-area-inset-bottom));}
  .tsms-more-sheet.show{transform:translateY(0);}
  .tsms-more-sheet a{display:block;padding:12px;border:2px solid var(--border,#ccc);margin-top:8px;text-decoration:none;color:var(--text-primary,#111);background:var(--surface-2,#f5f5f5);font-weight:900;}
  .tsms-more-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;z-index:1250;transition:opacity .2s;}
  .tsms-more-bg.show{opacity:1;pointer-events:auto;}
</style>

  <script type="module" src="auth-guard.js?v=20260223-5"></script>
  <script src="./custom-confirm.js"></script>
</head>
<body>

<nav class="menu" id="menu">
  <a href="index.html">TOP<small>メニュー一覧</small></a>
  <a href="report.html">日報入力<small>乗車データを入力</small></a>
  <a href="confirm.html">入力確認<small>当日・過去のデータを確認</small></a>
  <a href="detail.html">詳細確認<small>概算手取、集計結果など</small></a>
  <a href="ops.html">出庫 / 帰庫 / 休憩<small>休憩タイマーなど</small></a>
  <a href="sales.html">月間管理<small>当月、過去の売上確認</small></a>
  <a href="settings.html">設定<small>歩率、締め期間、シフトなど</small></a>
</nav>
<div class="menu-bg" id="menuBg"></div>

<header class="header">
  <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
  出庫 / 帰庫 / 休憩
  <a class="header-to-report" href="report.html">入力画面へ</a>
</header>

<main class="main">
  <section class="card">
    <div class="group-title">出庫 / 帰庫</div>
    <div class="actions">
      <button class="btn action-main" type="button" id="btn_depart">出庫（今）</button>
      <button class="btn action-main" type="button" id="btn_return">帰庫（今）</button>
    </div>

    <div class="content" style="margin-top:12px;">
      <div class="line"><div class="k">出庫時間</div><div class="v" id="v_depart">--</div></div>
      <div class="line"><div class="k">帰庫時間</div><div class="v" id="v_return">--</div></div>
    </div>

    <div class="group-title" style="margin-top:12px;">休憩</div>
    <div class="actions">
      <button class="btn action-main" type="button" id="btn_breakStart">休憩開始</button>
      <button class="btn action-main" type="button" id="btn_breakEnd">休憩解除</button>
    </div>

    <div class="content" style="margin-top:12px;">
      <div class="line"><div class="k">休憩合計</div><div class="v" id="v_break">--</div></div>
      <div class="line"><div class="k">実働（参考）</div><div class="v" id="v_work">--</div></div>
      <div class="line"><div class="k">休憩状態</div><div class="v"><span class="pill" id="v_breakState">未休憩</span></div></div>
      <div class="line"><div class="k">休憩タイマー</div><div class="v"><span id="v_breakTimer" style="font-weight:900;">0:00</span></div></div>
    </div>

    <div class="actions">
      <button class="btn danger wide reset-final" type="button" id="btn_reset">この日の記録をクリア<br><span class="warn">（〆作業として一番最後に実行）</span></button>
    </div>

    <div class="group-title" style="margin-top:12px;">休憩履歴</div>
    <div class="list" id="breakList"></div>
    <div class="bottom-mini-actions">
      <button class="btn btn-mini" type="button" id="btn_departCancel">出庫取消</button>
    </div>
    <div class="sync-meta" id="opsSyncMeta">最終クラウド同期: --</div>
  </section>
</main>

<div class="result-modal-bg" id="resultModalBg" aria-hidden="true">
  <div class="result-modal-card" role="dialog" aria-modal="true" aria-labelledby="resultModalMessage">
    <div class="result-modal-icon success" id="resultModalIcon" aria-hidden="true">○</div>
    <p class="result-modal-message" id="resultModalMessage">締め作業が完了しました</p>
    <div class="result-modal-actions">
      <button class="btn" type="button" id="resultModalCloseBtn">閉じる</button>
    </div>
  </div>
</div>

<script>
/* ===== Hamburger ===== */
const burger = document.getElementById("hamburger");
const menu = document.getElementById("menu");
const bg = document.getElementById("menuBg");
burger.onclick = () => { menu.classList.add("open"); bg.classList.add("show"); };
bg.onclick = () => { menu.classList.remove("open"); bg.classList.remove("show"); };

/* ===== Ops Logic ===== */
const KEY = "ops";
const OPS_ARCHIVE_KEY = "ops_archive_v1";
const OPS_SYNC_REV_KEY = "ops_sync_rev_v1";
const CLOUD_LAST_SUCCESS_AT_KEY = "tsms_cloud_last_success_at";
const CLOUD_LAST_FAILURE_AT_KEY = "tsms_cloud_last_failure_at";
const REPORT_KEY = "tsms_reports";
const REPORT_ARCHIVE_KEY = "tsms_reports_archive";
const CURRENT_DAY_KEY = "tsms_report_current_day";
const CONFIRM_FORCE_EMPTY_KEY = "tsms_confirm_force_empty";

function nowISO(){ return new Date().toISOString(); }
function localYmd(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function pad(n){ return String(n).padStart(2,"0"); }
function fmt(iso){
  if(!iso) return "--";
  const d = new Date(iso);
  if(isNaN(d)) return "--";
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function minDiff(aIso, bIso){
  const a = new Date(aIso).getTime();
  const b = new Date(bIso).getTime();
  if(isNaN(a) || isNaN(b)) return 0;
  return Math.max(0, Math.round((b - a) / 60000));
}
function fmtMin(m){
  const v = Number(m)||0;
  const h = Math.floor(v/60);
  const mm = v%60;
  if(h<=0) return `${mm}分`;
  return `${h}時間${mm}分`;
}
function fmtSyncDateTime(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(isNaN(d)) return "";
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function safeParse(){
  try{
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function markOpsSyncRevision(iso){
  const stamp = String(iso || nowISO());
  try{
    localStorage.setItem(OPS_SYNC_REV_KEY, stamp);
  }catch(e){}
  return stamp;
}
function save(data){
  try{
    const stamp = markOpsSyncRevision(nowISO());
    const dayId = localStorage.getItem(CURRENT_DAY_KEY) || localYmd();
    data.dayId = dayId;
    data.updatedAt = stamp;
    localStorage.setItem(KEY, JSON.stringify(data));
  }catch(e){}
}
function defaultData(){
  return {
    date: (new Date()).toISOString().slice(0,10),
    departAt: null,
    returnAt: null,
    breakActive: false,
    breakStartAt: null,
    breakSessions: [], // {start,end,minutes}
    shiftClosed: false,
    updatedAt: null
  };
}
function normalizeData(raw){
  const d = Object.assign(defaultData(), raw || {});
  d.breakSessions = Array.isArray(d.breakSessions) ? d.breakSessions : [];
  d.updatedAt = (typeof d.updatedAt === "string" && d.updatedAt) ? d.updatedAt : null;
  if(typeof d.shiftClosed !== "boolean") d.shiftClosed = !!d.returnAt;
  if(d.shiftClosed && d.breakActive){
    d.breakActive = false;
    d.breakStartAt = null;
  }
  return d;
}
function load(){ return normalizeData(safeParse() || defaultData()); }
function loadOpsArchive(){
  try{
    const raw = localStorage.getItem(OPS_ARCHIVE_KEY);
    if(!raw) return {};
    const obj = JSON.parse(raw);
    return (obj && typeof obj === "object") ? obj : {};
  }catch(e){
    return {};
  }
}
function saveOpsArchive(archive){
  try{
    localStorage.setItem(OPS_ARCHIVE_KEY, JSON.stringify(archive || {}));
  }catch(e){}
}

function calcBreakTotal(d){
  return (d.breakSessions||[]).reduce((s,x)=>s+(Number(x.minutes)||0),0);
}

function calcWorkMinutes(d){
  if(!d.departAt || !d.returnAt) return null;
  const total = minDiff(d.departAt, d.returnAt);
  const br = calcBreakTotal(d);
  return Math.max(0, total - br);
}

const vDepart = document.getElementById("v_depart");
const vReturn = document.getElementById("v_return");
const vBreak = document.getElementById("v_break");
const vWork = document.getElementById("v_work");
const vBreakState = document.getElementById("v_breakState");
const vBreakTimer = document.getElementById("v_breakTimer");
const breakList = document.getElementById("breakList");

const btnDepart = document.getElementById("btn_depart");
const btnDepartCancel = document.getElementById("btn_departCancel");
const btnReturn = document.getElementById("btn_return");
const btnBreakStart = document.getElementById("btn_breakStart");
const btnBreakEnd = document.getElementById("btn_breakEnd");
const btnReset = document.getElementById("btn_reset");
const resultModalBg = document.getElementById("resultModalBg");
const resultModalIcon = document.getElementById("resultModalIcon");
const resultModalMessage = document.getElementById("resultModalMessage");
const resultModalCloseBtn = document.getElementById("resultModalCloseBtn");
const opsSyncMeta = document.getElementById("opsSyncMeta");

function renderCloudSyncStatus(){
  if(!opsSyncMeta) return;
  const okAt = localStorage.getItem(CLOUD_LAST_SUCCESS_AT_KEY) || "";
  const ngAt = localStorage.getItem(CLOUD_LAST_FAILURE_AT_KEY) || "";
  const okMs = okAt ? new Date(okAt).getTime() : 0;
  const ngMs = ngAt ? new Date(ngAt).getTime() : 0;

  if(okMs && okMs >= ngMs){
    opsSyncMeta.classList.remove("error");
    opsSyncMeta.textContent = `最終クラウド同期: ${fmtSyncDateTime(okAt)}`;
    return;
  }
  if(ngMs){
    opsSyncMeta.classList.add("error");
    opsSyncMeta.textContent = "最終クラウド同期: 失敗（再試行してください）";
    return;
  }
  opsSyncMeta.classList.remove("error");
  opsSyncMeta.textContent = "最終クラウド同期: --";
}

function showResultModal(message, isSuccess){
  if(!resultModalBg || !resultModalIcon || !resultModalMessage || !resultModalCloseBtn){
    alert(String(message || ""));
    return Promise.resolve();
  }
  resultModalMessage.textContent = String(message || "");
  resultModalIcon.textContent = isSuccess ? "○" : "×";
  resultModalIcon.classList.toggle("success", !!isSuccess);
  resultModalIcon.classList.toggle("error", !isSuccess);

  return new Promise((resolve)=>{
    const close = ()=>{
      resultModalBg.classList.remove("show");
      resultModalBg.setAttribute("aria-hidden", "true");
      resultModalCloseBtn.removeEventListener("click", onClose);
      resultModalBg.removeEventListener("click", onBg);
      document.removeEventListener("keydown", onEsc);
      resolve();
    };
    const onClose = ()=> close();
    const onBg = (e)=>{ if(e.target === resultModalBg) close(); };
    const onEsc = (e)=>{ if(e.key === "Escape") close(); };

    resultModalBg.classList.add("show");
    resultModalBg.setAttribute("aria-hidden", "false");
    resultModalCloseBtn.addEventListener("click", onClose);
    resultModalBg.addEventListener("click", onBg);
    document.addEventListener("keydown", onEsc);
    resultModalCloseBtn.focus();
  });
}

function fmtTimer(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,"0")}`;
}
function updateBreakTimer(d){
  if(!vBreakTimer) return;
  if(d && d.breakActive && d.breakStartAt){
    const start = new Date(d.breakStartAt).getTime();
    const now = Date.now();
    const sec = (now - start) / 1000;
    vBreakTimer.textContent = fmtTimer(sec);
  } else {
    vBreakTimer.textContent = "0:00";
  }
}

function render(){
  const d = load();
  renderCloudSyncStatus();

  vDepart.textContent = fmt(d.departAt);
  vReturn.textContent = fmt(d.returnAt);

  const brMin = calcBreakTotal(d);
  vBreak.textContent = fmtMin(brMin);

  const workMin = calcWorkMinutes(d);
  vWork.textContent = (workMin === null) ? "--" : fmtMin(workMin);

  if(d.breakActive){
    vBreakState.textContent = "休憩中";
    updateBreakTimer(d);
    vBreakState.style.borderColor = "#333";
  } else {
    vBreakState.textContent = "未休憩";
    vBreakState.style.borderColor = "var(--border)";
  }

  // buttons state
  const hasDepart = !!d.departAt;
  const hasReturn = !!d.returnAt;
  const running = hasDepart && !hasReturn && !d.shiftClosed;

  if(d.shiftClosed){
    btnDepart.disabled = true;
    if(btnDepartCancel) btnDepartCancel.disabled = true;
    btnReturn.disabled = true;
  } else if(hasReturn){
    // 帰庫後〜日次クリア前は時刻修正のためデータは保持しつつ、再出庫は不可にする
    btnDepart.disabled = true;
    if(btnDepartCancel) btnDepartCancel.disabled = true;
    btnReturn.disabled = true;
  } else if(running){
    btnDepart.disabled = true;
    if(btnDepartCancel) btnDepartCancel.disabled = false;
    btnReturn.disabled = false;
  } else {
    btnDepart.disabled = false;
    if(btnDepartCancel) btnDepartCancel.disabled = true;
    btnReturn.disabled = true;
  }

  btnBreakStart.disabled = d.shiftClosed || d.breakActive || !running;
  btnBreakEnd.disabled = d.shiftClosed || !d.breakActive;

  btnDepart.classList.toggle("next", !btnDepart.disabled);
  if(btnDepartCancel) btnDepartCancel.classList.toggle("next", !btnDepartCancel.disabled);
  btnReturn.classList.toggle("next", !btnReturn.disabled);
  btnBreakStart.classList.toggle("next", !btnBreakStart.disabled);
  btnBreakEnd.classList.toggle("next", !btnBreakEnd.disabled);

  // list
  const sessions = d.breakSessions || [];
  if(!sessions.length){
    breakList.innerHTML = '<div class="note">休憩履歴なし</div>';
  } else {
    breakList.innerHTML = sessions.map((s,i)=>`
        <div class="item">
          <div class="idx">#${i+1}</div>
          <div class="txt">${fmt(s.start)} → ${fmt(s.end)}</div>
          <div class="dur">${fmtMin(s.minutes)}</div>
        </div>
      `).join("");
  }
}

btnDepart.onclick = ()=>{
  const d = load();
  d.departAt = nowISO();
  d.returnAt = null;
  d.shiftClosed = false;
  localStorage.removeItem(CONFIRM_FORCE_EMPTY_KEY);
  const nextDayId = localYmd();
  localStorage.setItem(CURRENT_DAY_KEY, nextDayId);
  d.dayId = nextDayId;
  save(d);
  render();
};

if(btnDepartCancel){
  btnDepartCancel.onclick = async ()=>{
    const d = load();
    if(!d.departAt || d.returnAt || d.shiftClosed) return;
    if(!(await window.tsmsConfirm("出庫を取り消しますか？（出庫時間・休憩状態を初期化します）"))) return;

    localStorage.removeItem(KEY);
    localStorage.removeItem(CURRENT_DAY_KEY);
    localStorage.setItem(CONFIRM_FORCE_EMPTY_KEY, "1");
    markOpsSyncRevision(nowISO());
    render();
  };
}

btnReturn.onclick = async ()=>{
  if(!(await window.tsmsConfirm("帰庫しますか？"))) return;

  const d = load();
  const end = nowISO();

  if(d.breakActive && d.breakStartAt){
    const minutes = minDiff(d.breakStartAt, end);
    d.breakSessions = d.breakSessions || [];
    d.breakSessions.push({
      start: d.breakStartAt,
      end,
      minutes
    });
  }

  d.breakActive = false;
  d.breakStartAt = null;
  d.returnAt = end;
  d.shiftClosed = false;
  d.dayId = localStorage.getItem(CURRENT_DAY_KEY) || localYmd();
  save(d);
  render();
};

btnBreakStart.onclick = ()=>{
  const d = load();
  if(d.breakActive) return;
  d.breakActive = true;
  d.breakStartAt = nowISO();
  save(d);
  render();
};

btnBreakEnd.onclick = ()=>{
  const d = load();
  if(!d.breakActive || !d.breakStartAt) return;
  const end = nowISO();
  const minutes = minDiff(d.breakStartAt, end);
  d.breakSessions = d.breakSessions || [];
  d.breakSessions.push({
    start: d.breakStartAt,
    end,
    minutes
  });
  d.breakActive = false;
  d.breakStartAt = null;
  save(d);
  render();
};

btnReset.onclick = async ()=>{
  if(!(await window.tsmsConfirm("この日の記録をクラウドへ保存してからクリアします。よろしいですか？"))) return;

  btnReset.disabled = true;
  const backupNow = (window.tsmsCloud && typeof window.tsmsCloud.backupNow === "function")
    ? window.tsmsCloud.backupNow
    : null;
  let shouldLogoutAfterClear = false;
  try{
    if(!backupNow){
      throw new Error("cloud_backup_unavailable");
    }
    await backupNow();

    if(window.tsmsCloud && typeof window.tsmsCloud.setSyncPaused === "function") {
      window.tsmsCloud.setSyncPaused(true);
    }
    try{
      const opsData = load();
      const currentDayId = localStorage.getItem(CURRENT_DAY_KEY) || (opsData.dayId || localYmd());
      const syncStamp = nowISO();
      const activeRows = JSON.parse(localStorage.getItem(REPORT_KEY) || "[]");
      const archiveRows = JSON.parse(localStorage.getItem(REPORT_ARCHIVE_KEY) || "[]");

      const todayRows = (Array.isArray(activeRows) ? activeRows : []).filter((r)=> String((r && r.dayId) || "") === String(currentDayId));
      const remainRows = (Array.isArray(activeRows) ? activeRows : []).filter((r)=> String((r && r.dayId) || "") !== String(currentDayId));

      const byId = new Map();
      (Array.isArray(archiveRows) ? archiveRows : []).forEach((r)=>{ if(r && r.id) byId.set(String(r.id), r); });
      todayRows.forEach((r)=>{ if(r && r.id) byId.set(String(r.id), r); });

      if(opsData && (opsData.departAt || opsData.returnAt || (Array.isArray(opsData.breakSessions) && opsData.breakSessions.length))){
        const archive = loadOpsArchive();
        archive[String(currentDayId)] = Object.assign({}, opsData, {
          dayId: String(currentDayId),
          shiftClosed: true,
          updatedAt: syncStamp
        });
        saveOpsArchive(archive);
      }

      localStorage.removeItem(KEY);
      localStorage.removeItem(CURRENT_DAY_KEY);
      localStorage.setItem(CONFIRM_FORCE_EMPTY_KEY, "1");
      markOpsSyncRevision(syncStamp);
      localStorage.setItem(REPORT_KEY, JSON.stringify(remainRows));
      localStorage.setItem(REPORT_ARCHIVE_KEY, JSON.stringify(Array.from(byId.values())));
      render();
      shouldLogoutAfterClear = true;
    } finally {
      if(window.tsmsCloud && typeof window.tsmsCloud.setSyncPaused === "function") {
        window.tsmsCloud.setSyncPaused(false);
      }
    }

    await backupNow();
    renderCloudSyncStatus();
    await showResultModal("締め作業が完了しました", true);
  }catch(e){
    renderCloudSyncStatus();
    await showResultModal("バックアップに失敗しました。もう一度実行してください。", false);
  }

  if(shouldLogoutAfterClear && window.tsmsCloud && typeof window.tsmsCloud.logout === "function"){
    try{
      await window.tsmsCloud.logout();
      return;
    }catch(e){
      alert("ログアウトに失敗しました。いったんそのままご利用ください。");
    }
  }

  btnReset.disabled = false;
};

render();
setInterval(()=>{ try{ updateBreakTimer(load()); }catch(e){} }, 1000);
</script>




  <script>
    (function(){if('serviceWorker'in navigator&&location.protocol.indexOf('http')===0){window.addEventListener('load',function(){navigator.serviceWorker.register('./sw.js?v=20260223-16').catch(function(){});});}})();
  </script>


<nav class="tsms-bottom-nav" aria-label="ボトムメニュー">
  <a href="report.html" data-tab="report"><span>日報入力</span></a>
  <a href="confirm.html" data-tab="confirm"><span>入力確認</span></a>
  <a href="detail.html" data-tab="detail"><span>詳細確認</span></a>
  <a href="ops.html" data-tab="ops"><span>出庫/帰庫</span></a>
  <button type="button" id="tsmsMoreBtn"><span>その他</span></button>
</nav>
<div class="tsms-more-bg" id="tsmsMoreBg"></div>
<div class="tsms-more-sheet" id="tsmsMoreSheet" aria-label="その他メニュー">
  <a href="index.html">TOP</a>
  <a href="sales.html">月間管理</a>
  <a href="settings.html">設定</a>
</div>
<script>
(function(){
  var page=(location.pathname.split('/').pop()||'index.html').replace('.html','');
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    if(a.getAttribute('data-tab')===page) a.classList.add('active');
  });  var btn=document.getElementById('tsmsMoreBtn');
  var bg=document.getElementById('tsmsMoreBg');
  var sheet=document.getElementById('tsmsMoreSheet');
  function closeMore(){sheet.classList.remove('show');bg.classList.remove('show');}
  if(btn&&bg&&sheet){
    btn.addEventListener('click',function(){sheet.classList.add('show');bg.classList.add('show');});
    bg.addEventListener('click',closeMore);
  }
  var guard = page==='report';
  function isDirtyReport(){
    var cash=document.getElementById('in_cash');
    var credit=document.getElementById('in_credit');
    var note=document.getElementById('in_note');
    var hasVal=((cash&&cash.value)||(credit&&credit.value)||(note&&note.value));
    var selected=document.querySelector('button[data-group].is-selected');
    return !!(hasVal||selected);
  }
  document.querySelectorAll('.tsms-bottom-nav a, .tsms-more-sheet a').forEach(function(a){
    a.addEventListener('click',async function(e){
      if(guard && isDirtyReport() && !(await window.tsmsConfirm('入力を中止しますか？'))){
        e.preventDefault();
      }
      closeMore();
    });
  });
})();
</script>

  <script src="./cache-version.js"></script>
</body>
</html>
