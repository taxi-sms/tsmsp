<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TSMS TOP</title>
<link rel="icon" href="favicon.ico" sizes="any">
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="TSMS">
<script>(function(){try{var t=localStorage.getItem("tsms_theme")==="dark"?"dark":"light";document.documentElement.setAttribute("data-theme",t);var m=document.querySelector('meta[name="theme-color"]');if(m)m.setAttribute("content",t==="dark"?"#0F1417":"#F3F6F8");}catch(e){}})();</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module" src="auth-guard.js?v=20260223-5"></script>
<script src="./custom-confirm.js"></script>
<link rel="stylesheet" href="./tsms-design.css?v=20260227-3">
<style>
:root{
  --bg:#F3F6F8;
  --surface-1:#FFFFFF;
  --surface-2:#EEF3F6;
  --border:#D5DEE6;
  --text-primary:#0F1720;
  --text-secondary:#344554;
  --text-muted:#5B6D7C;
  --accent:#2580ED;
  --work:#1c9b2d;
  --holiday:#f0ad00;
  --danger:#d64545;
}
:root[data-theme="dark"]{
  --bg:#0F1417;
  --surface-1:#0e1a2d;
  --surface-2:#0a1630;
  --border:#2f4d77;
  --text-primary:#ecf3ff;
  --text-secondary:#b6c8e6;
  --text-muted:#89a3c7;
  --accent:#4da3ff;
  --work:#1c9b2d;
  --holiday:#f0ad00;
  --danger:#d64545;
}
html,body{
  margin:0;
  padding:0;
  background:var(--bg);
  color:var(--text-primary);
  font-family:"Noto Sans JP",sans-serif;
}
body{padding-bottom:78px;}
.header{
  position:sticky;
  top:0;
  z-index:20;
  min-height:60px;
  border-bottom:2px solid var(--border);
  background:var(--surface-1);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:0 14px;
  font-weight:900;
}
:root[data-theme="dark"] .header{
  background:linear-gradient(180deg, rgba(22,42,76,.95), rgba(10,22,47,.95));
  box-shadow:0 10px 24px rgba(0,0,0,.3);
}
.header-title{
  font-size:36px;
  line-height:1;
  letter-spacing:.02em;
}
.header-meta{
  display:flex;
  gap:6px;
  align-items:center;
  font-size:13px;
  color:var(--text-secondary);
  font-weight:700;
  text-align:right;
}
.main{
  max-width:760px;
  margin:0 auto;
  padding:12px;
  display:grid;
  gap:8px;
}
.card{
  border:2px solid var(--border);
  background:var(--surface-1);
  border-radius:14px;
  padding:10px;
}
.dispatch-card{padding-bottom:8px;}
:root[data-theme="dark"] .card{
  background:linear-gradient(180deg, rgba(19,38,70,.95), rgba(8,20,42,.95));
  box-shadow:0 10px 26px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.08);
}
.group-title{
  display:flex;
  align-items:center;
  gap:10px;
  margin:0 0 8px;
  font-size:26px;
  font-weight:900;
}
.group-title::after{
  content:"";
  flex:1 1 auto;
  border-top:2px solid var(--border);
  opacity:.95;
}
.group-note{
  margin:0 0 8px;
  font-size:13px;
  color:var(--text-muted);
  font-weight:700;
}
.swipe-track{
  position:relative;
  min-height:60px;
  border:2px solid var(--border);
  background:var(--surface-2);
  border-radius:999px;
  padding:4px;
  overflow:hidden;
  touch-action:pan-y;
}
:root[data-theme="dark"] .swipe-track{
  background:linear-gradient(90deg, rgba(20,40,74,.92), rgba(62,118,194,.55));
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.05);
}
.swipe-track.locked{ border-color:var(--accent); }
.swipe-track.locked .swipe-label{
  left:12px;
  right:12px;
  text-align:center;
}
.swipe-label{
  position:absolute;
  left:72px;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  font-size:26px;
  font-weight:900;
  color:var(--text-secondary);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
:root[data-theme="dark"] .swipe-label{ color:#e3efff; }
.swipe-handle{
  position:absolute;
  left:4px;
  top:50%;
  width:48px;
  height:48px;
  border:2px solid var(--accent);
  border-radius:999px;
  background:var(--accent);
  color:#fff;
  font:inherit;
  font-size:26px;
  font-weight:900;
  line-height:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
  cursor:pointer;
  touch-action:none;
  transform:translate3d(0,-50%,0);
}
:root[data-theme="dark"] .swipe-handle{
  background:linear-gradient(180deg, #78c5ff, #3f9bff);
  border-color:#8ad0ff;
  box-shadow:0 4px 14px rgba(45,140,255,.45);
}
.swipe-track.dragging .swipe-handle{ transition:none !important; }
.calendar-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}
.calendar-month{
  margin:0;
  font-size:18px;
  font-weight:900;
  color:var(--text-secondary);
}
.calendar-nav{
  display:flex;
  align-items:center;
  gap:6px;
}
.calendar-nav-btn{
  appearance:none;
  width:32px;
  height:32px;
  border:2px solid var(--border);
  border-radius:8px;
  background:var(--surface-2);
  color:var(--text-primary);
  font:inherit;
  font-size:20px;
  line-height:1;
  font-weight:900;
  display:grid;
  place-items:center;
  cursor:pointer;
}
:root[data-theme="dark"] .calendar-nav-btn{
  background:linear-gradient(180deg, rgba(16,33,62,.9), rgba(9,20,39,.9));
}
.calendar-week,
.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,minmax(0,1fr));
  gap:5px;
}
.calendar-week span{
  text-align:center;
  font-size:13px;
  color:var(--text-muted);
  font-weight:800;
}
.calendar-day{
  border:2px solid var(--border);
  border-radius:8px;
  background:var(--surface-2);
  min-height:44px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:2px;
  font:inherit;
  font-size:13px;
  font-weight:800;
  color:var(--text-primary);
  padding:2px;
}
:root[data-theme="dark"] .calendar-day{
  background:linear-gradient(180deg, rgba(15,31,58,.9), rgba(9,20,40,.9));
}
.calendar-day.empty{
  border-style:dashed;
  opacity:.35;
}
.calendar-day.today{
  border-color:var(--accent);
}
:root[data-theme="dark"] .calendar-day.today{
  box-shadow:0 0 0 2px rgba(88,194,255,.18), 0 0 14px rgba(65,148,255,.35);
}
.shift-dot{width:8px;height:8px;border-radius:50%;display:block;}
.shift-dot.work{background:var(--work);}
.shift-dot.holiday{background:var(--holiday);}
.shift-dot.absence{background:var(--danger);}
.calendar-info{
  margin:8px 0 0;
  border:1px solid var(--border);
  border-radius:8px;
  background:var(--surface-2);
  padding:8px;
  font-size:13px;
  color:var(--text-secondary);
}
:root[data-theme="dark"] .calendar-info{
  background:linear-gradient(180deg, rgba(14,30,55,.88), rgba(10,22,42,.88));
}
.event-list{display:grid;gap:8px;}
.event-btn{
  appearance:none;
  border:2px solid var(--border);
  border-radius:10px;
  background:var(--surface-2);
  color:var(--text-primary);
  font:inherit;
  width:100%;
  min-height:52px;
  padding:0 10px;
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:900;
  text-align:left;
  cursor:pointer;
}
:root[data-theme="dark"] .event-btn{
  background:linear-gradient(180deg, rgba(16,33,62,.9), rgba(9,20,39,.9));
}
.event-time{
  min-width:56px;
  font-variant-numeric:tabular-nums;
  color:var(--text-secondary);
}
.event-arrow{
  margin-left:auto;
  color:var(--text-muted);
  font-size:20px;
  line-height:1;
}
:root[data-theme="dark"] .event-arrow{ color:#7fb9ff; }
.modal-bg{
  position:fixed;
  inset:0;
  z-index:1600;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:12px;
}
.modal-bg.show{display:flex;}
.modal{
  width:min(420px,100%);
  border:2px solid var(--border);
  border-radius:12px;
  background:var(--surface-1);
  padding:12px;
}
:root[data-theme="dark"] .modal{
  background:linear-gradient(180deg, rgba(19,38,70,.96), rgba(10,24,45,.96));
}
.modal h3{margin:0 0 8px;font-size:20px;}
.modal p{margin:0 0 10px;font-size:14px;color:var(--text-secondary);}
.modal .btn{
  appearance:none;
  width:100%;
  min-height:42px;
  border:2px solid var(--accent);
  border-radius:8px;
  background:var(--accent);
  color:#fff;
  font:inherit;
  font-weight:900;
  cursor:pointer;
}
.tsms-bottom-nav{position:fixed;left:0;right:0;bottom:0;z-index:1200;display:grid;grid-template-columns:repeat(5,1fr);background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);padding-bottom:env(safe-area-inset-bottom);}
.tsms-bottom-nav a,.tsms-bottom-nav button{appearance:none;border:0;background:transparent;color:var(--text-secondary,#445);font:inherit;font-size:11px;font-weight:900;padding:8px 2px 9px;min-height:58px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;text-decoration:none;}
.tsms-bottom-nav .ico{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;color:#58C2FF;}
.tsms-bottom-nav .ico svg{width:22px;height:22px;stroke:#58C2FF;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;display:block;}
.tsms-bottom-nav .active{color:var(--text-primary,#111);position:relative;}
.tsms-bottom-nav .active::before{content:"";position:absolute;top:0;left:14%;right:14%;height:2px;background:#58C2FF;}
.tsms-more-sheet{position:fixed;left:0;right:0;bottom:0;z-index:1300;background:var(--surface-1,#fff);border-top:2px solid var(--border,#ccc);transform:translateY(110%);transition:transform .2s ease;padding:12px 12px calc(12px + env(safe-area-inset-bottom));}
.tsms-more-sheet.show{transform:translateY(0);}
.tsms-more-sheet a{display:block;padding:12px;border:2px solid var(--border,#ccc);margin-top:8px;text-decoration:none;color:var(--text-primary,#111);background:var(--surface-2,#f5f5f5);font-weight:900;}
.tsms-more-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;pointer-events:none;z-index:1250;transition:opacity .2s;}
.tsms-more-bg.show{opacity:1;pointer-events:auto;}
@media (max-width:460px){
  .header-title{font-size:30px;}
  .header-meta{font-size:12px;}
  .group-title{font-size:22px;}
  .swipe-label{font-size:22px;}

}
</style>

</head>
<body>

<header class="header">
  <div class="header-title">TSMS</div>
  <div class="header-meta">
    <span id="syncStatusInline">åŒæœŸçŠ¶æ…‹: --</span>
    <span>/</span>
    <span id="cacheVersionInline">cache: --</span>
  </div>
</header>

<main class="main" role="main">
  <section class="card dispatch-card" aria-label="å‡ºåº«é–‹å§‹">
    <h2 class="group-title">å‡ºåº«ã‚’é–‹å§‹</h2>
    <div class="swipe-track" id="dispatchSwipeTrack">
      <span class="swipe-label" id="dispatchSwipeLabel">å³ã«ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦å‡ºåº«</span>
      <button type="button" class="swipe-handle" id="dispatchSwipeHandle" aria-label="å³ã«ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦å‡ºåº«">â€º</button>
    </div>
  </section>

  <section class="card" aria-label="å‹¤å‹™ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼">
    <div class="calendar-head">
      <h2 class="group-title" style="margin:0;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
      <div class="calendar-nav">
        <button type="button" class="calendar-nav-btn" id="calendarPrevBtn" aria-label="å‰æœˆ">â€¹</button>
        <p class="calendar-month" id="calendarMonthTitle">-</p>
        <button type="button" class="calendar-nav-btn" id="calendarNextBtn" aria-label="ç¿Œæœˆ">â€º</button>
      </div>
    </div>
    <div class="calendar-week" aria-hidden="true">
      <span>æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span>åœŸ</span>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
    <p class="calendar-info" id="calendarInfo">æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å‹¤å‹™æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
  </section>

  <section class="card" aria-label="æœ¬æ—¥ãƒ»è¿‘æ—¥ã‚¤ãƒ™ãƒ³ãƒˆ">
    <h2 class="group-title">æœ¬æ—¥ãƒ»è¿‘æ—¥ã‚¤ãƒ™ãƒ³ãƒˆ</h2>
    <p class="group-note">ã‚¤ãƒ™ãƒ³ãƒˆé€£æºã¯æº–å‚™ä¸­ï¼ˆTBAï¼‰</p>
    <div class="event-list">
      <button type="button" class="event-btn" data-event-title="ã‚¤ãƒ™ãƒ³ãƒˆ #1" data-event-detail="TBAï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé€£æºæœªå®Ÿè£…ï¼‰">
        <span class="event-time">TBA</span>
        <span>å½“æ—¥ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæº–å‚™ä¸­ï¼‰</span>
        <span class="event-arrow">â€º</span>
      </button>
      <button type="button" class="event-btn" data-event-title="ã‚¤ãƒ™ãƒ³ãƒˆ #2" data-event-detail="TBAï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé€£æºæœªå®Ÿè£…ï¼‰">
        <span class="event-time">TBA</span>
        <span>è¿‘æ—¥ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæº–å‚™ä¸­ï¼‰</span>
        <span class="event-arrow">â€º</span>
      </button>
      <button type="button" class="event-btn" data-event-title="ã‚¤ãƒ™ãƒ³ãƒˆ #3" data-event-detail="TBAï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé€£æºæœªå®Ÿè£…ï¼‰">
        <span class="event-time">TBA</span>
        <span>è¿‘æ—¥ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæº–å‚™ä¸­ï¼‰</span>
        <span class="event-arrow">â€º</span>
      </button>
    </div>
  </section>
</main>

<div class="modal-bg" id="eventModalBg" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
    <h3 id="eventModalTitle">ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
    <p id="eventModalDetail">TBA</p>
    <button type="button" class="btn" id="eventModalCloseBtn">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
(function(){
  var KEY_OPS = "ops";
  var KEY_CURRENT_DAY = "tsms_report_current_day";
  var KEY_CONFIRM_FORCE_EMPTY = "tsms_confirm_force_empty";
  var KEY_OPS_SYNC_REV = "ops_sync_rev_v1";
  var KEY_SALES_PLAN = "tsms_sales_plan";
  var KEY_CLOUD_OK = "tsms_cloud_last_success_at";
  var KEY_CLOUD_NG = "tsms_cloud_last_failure_at";

  var syncInline = document.getElementById("syncStatusInline");
  var dispatchTrack = document.getElementById("dispatchSwipeTrack");
  var dispatchHandle = document.getElementById("dispatchSwipeHandle");
  var dispatchLabel = document.getElementById("dispatchSwipeLabel");
  var calendarMonthTitle = document.getElementById("calendarMonthTitle");
  var calendarPrevBtn = document.getElementById("calendarPrevBtn");
  var calendarNextBtn = document.getElementById("calendarNextBtn");
  var calendarGrid = document.getElementById("calendarGrid");
  var calendarInfo = document.getElementById("calendarInfo");
  var calendarCursor = (function(){
    var now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), 1);
  })();
  var eventModalBg = document.getElementById("eventModalBg");
  var eventModalTitle = document.getElementById("eventModalTitle");
  var eventModalDetail = document.getElementById("eventModalDetail");
  var eventModalCloseBtn = document.getElementById("eventModalCloseBtn");

  function nowISO(){ return new Date().toISOString(); }
  function localYmd(){
    var d = new Date();
    return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtHm(iso){
    if(!iso) return "--:--";
    var d = new Date(iso);
    if(isNaN(d)) return "--:--";
    return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
  }
  function safeJsonParse(raw, fallback){
    try{
      var val = JSON.parse(raw);
      return (val == null ? fallback : val);
    }catch(_){
      return fallback;
    }
  }
  function defaultOpsData(){
    return {
      date: (new Date()).toISOString().slice(0,10),
      departAt: null,
      returnAt: null,
      breakActive: false,
      breakStartAt: null,
      breakSessions: [],
      shiftClosed: false,
      updatedAt: null,
      dayId: ""
    };
  }
  function normalizeOpsData(raw){
    var d = Object.assign(defaultOpsData(), raw || {});
    d.breakSessions = Array.isArray(d.breakSessions) ? d.breakSessions : [];
    if(typeof d.shiftClosed !== "boolean") d.shiftClosed = !!d.returnAt;
    if(d.shiftClosed && d.breakActive){
      d.breakActive = false;
      d.breakStartAt = null;
    }
    return d;
  }
  function loadOps(){
    return normalizeOpsData(safeJsonParse(localStorage.getItem(KEY_OPS), defaultOpsData()));
  }
  function saveOps(data){
    var stamp = nowISO();
    var d = normalizeOpsData(data);
    d.updatedAt = stamp;
    localStorage.setItem(KEY_OPS_SYNC_REV, stamp);
    localStorage.setItem(KEY_OPS, JSON.stringify(d));
  }

  function updateSyncStatus(){
    if(!syncInline) return;
    var okAt = localStorage.getItem(KEY_CLOUD_OK) || "";
    var ngAt = localStorage.getItem(KEY_CLOUD_NG) || "";
    var okMs = okAt ? new Date(okAt).getTime() : 0;
    var ngMs = ngAt ? new Date(ngAt).getTime() : 0;
    if(okMs && okMs >= ngMs){
      syncInline.textContent = "åŒæœŸå¾…æ¸ˆã¿";
      return;
    }
    if(ngMs){
      syncInline.textContent = "åŒæœŸã‚¨ãƒ©ãƒ¼";
      return;
    }
    syncInline.textContent = "åŒæœŸçŠ¶æ…‹: --";
  }

  var dragging = false;
  var dragPointerId = null;
  var dragStartX = 0;
  var dragStartPos = 0;
  var currentPos = 0;

  function getMaxHandleX(){
    if(!dispatchTrack || !dispatchHandle) return 0;
    return Math.max(0, dispatchTrack.clientWidth - dispatchHandle.offsetWidth - 10);
  }
  function setHandlePos(px, animate){
    if(!dispatchHandle) return;
    var x = Math.max(0, Math.min(getMaxHandleX(), Number(px)||0));
    currentPos = x;
    dispatchHandle.style.transition = animate ? "transform .18s ease" : "none";
    dispatchHandle.style.transform = "translate3d(" + x + "px,-50%,0)";
  }
  function lockDispatchSlider(departAt){
    if(!dispatchTrack || !dispatchLabel) return;
    dispatchTrack.classList.add("locked");
    var t = fmtHm(departAt);
    dispatchLabel.textContent = "å‡ºåº«æ¸ˆã¿ " + (t === "--:--" ? "" : t);
    setHandlePos(getMaxHandleX(), true);
  }
  function unlockDispatchSlider(){
    if(!dispatchTrack || !dispatchLabel) return;
    dispatchTrack.classList.remove("locked");
    dispatchTrack.classList.remove("dragging");
    dispatchLabel.textContent = "å³ã«ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦å‡ºåº«";
    setHandlePos(0, true);
  }

  function renderDispatchState(){
    var d = loadOps();
    if(d.departAt){
      lockDispatchSlider(d.departAt);
      return;
    }
    unlockDispatchSlider();
  }

  function runDispatch(){
    var d = loadOps();
    if(d.departAt){
      renderDispatchState();
      return;
    }
    var dayId = localYmd();
    localStorage.removeItem(KEY_CONFIRM_FORCE_EMPTY);
    localStorage.setItem(KEY_CURRENT_DAY, dayId);
    d.dayId = dayId;
    d.departAt = nowISO();
    d.returnAt = null;
    d.shiftClosed = false;
    saveOps(d);
    renderDispatchState();
  }

  if(dispatchHandle && dispatchTrack){
    dispatchHandle.addEventListener("pointerdown", function(e){
      if(dispatchTrack.classList.contains("locked")) return;
      dragging = true;
      dragPointerId = e.pointerId;
      dragStartX = e.clientX;
      dragStartPos = currentPos;
      dispatchTrack.classList.add("dragging");
      try{ dispatchHandle.setPointerCapture(e.pointerId); }catch(_){ }
      e.preventDefault();
    });

    dispatchHandle.addEventListener("pointermove", function(e){
      if(!dragging || e.pointerId !== dragPointerId) return;
      var dx = e.clientX - dragStartX;
      setHandlePos(dragStartPos + dx, false);
      e.preventDefault();
    });

    function finishDrag(pointerId){
      if(!dragging || pointerId !== dragPointerId) return;
      dragging = false;
      dragPointerId = null;
      if(dispatchTrack) dispatchTrack.classList.remove("dragging");
      var max = getMaxHandleX();
      var passed = (max > 0) && (currentPos >= max * 0.82);
      if(passed){
        setHandlePos(max, true);
        runDispatch();
      }else{
        setHandlePos(0, true);
      }
    }

    dispatchHandle.addEventListener("pointerup", function(e){ finishDrag(e.pointerId); });
    dispatchHandle.addEventListener("pointercancel", function(e){ finishDrag(e.pointerId); });
    window.addEventListener("resize", function(){
      if(dispatchTrack && dispatchTrack.classList.contains("locked")) setHandlePos(getMaxHandleX(), false);
      else setHandlePos(0, false);
    });
  }

  function loadSalesPlan(){
    return safeJsonParse(localStorage.getItem(KEY_SALES_PLAN), {});
  }
  function shiftMeta(shift){
    if(shift === "work" || shift === "part" || shift === "furidashi") return {label:"å‡ºå‹¤", dot:"work"};
    if(shift === "holiday" || shift === "furikyu") return {label:"ä¼‘æ—¥", dot:"holiday"};
    if(shift === "absence") return {label:"æ¬ å‹¤", dot:"absence"};
    return {label:"æœªè¨­å®š", dot:""};
  }
function renderCalendar(){
  if(!calendarGrid || !calendarMonthTitle) return;
  var year = calendarCursor.getFullYear();
  var month = calendarCursor.getMonth();
  var first = new Date(year, month, 1);
  var startWeekday = first.getDay();
  var days = new Date(year, month + 1, 0).getDate();
  var todayYmd = localYmd();
  var plan = loadSalesPlan();

  calendarMonthTitle.textContent = year + "å¹´" + (month + 1) + "æœˆ";
  calendarGrid.innerHTML = "";
  if(calendarInfo) calendarInfo.textContent = "æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å‹¤å‹™æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚";

  for(var blank = 0; blank < startWeekday; blank += 1){
    var empty = document.createElement("div");
    empty.className = "calendar-day empty";
    empty.setAttribute("aria-hidden", "true");
    calendarGrid.appendChild(empty);
  }

  for(var day = 1; day <= days; day += 1){
    var dayId = year + "-" + String(month + 1).padStart(2, "0") + "-" + String(day).padStart(2, "0");
    var row = plan[dayId] || {};
    var meta = shiftMeta(row.shift || "");
    var btn = document.createElement("button");
    btn.type = "button";
    btn.className = "calendar-day" + (dayId === todayYmd ? " today" : "");
    btn.dataset.dayId = dayId;
    btn.dataset.shiftLabel = meta.label;
    btn.innerHTML = '<span>' + day + '</span>' + (meta.dot ? '<span class="shift-dot ' + meta.dot + '"></span>' : '');
    btn.addEventListener("click", function(ev){
      var target = ev.currentTarget;
      if(!calendarInfo || !target) return;
      calendarInfo.textContent = target.dataset.dayId + " : " + (target.dataset.shiftLabel || "æœªè¨­å®š");
    });
    calendarGrid.appendChild(btn);
  }
}

if(calendarPrevBtn){
  calendarPrevBtn.addEventListener("click", function(){
    calendarCursor = new Date(calendarCursor.getFullYear(), calendarCursor.getMonth() - 1, 1);
    renderCalendar();
  });
}
if(calendarNextBtn){
  calendarNextBtn.addEventListener("click", function(){
    calendarCursor = new Date(calendarCursor.getFullYear(), calendarCursor.getMonth() + 1, 1);
    renderCalendar();
  });
}

  function closeEventModal(){
    if(!eventModalBg) return;
    eventModalBg.classList.remove("show");
    eventModalBg.setAttribute("aria-hidden", "true");
  }
  if(eventModalCloseBtn){
    eventModalCloseBtn.addEventListener("click", closeEventModal);
  }
  if(eventModalBg){
    eventModalBg.addEventListener("click", function(e){
      if(e.target === eventModalBg) closeEventModal();
    });
  }
  document.querySelectorAll(".event-btn").forEach(function(btn){
    btn.addEventListener("click", function(){
      if(!eventModalBg || !eventModalTitle || !eventModalDetail) return;
      eventModalTitle.textContent = btn.dataset.eventTitle || "ã‚¤ãƒ™ãƒ³ãƒˆ";
      eventModalDetail.textContent = btn.dataset.eventDetail || "TBA";
      eventModalBg.classList.add("show");
      eventModalBg.setAttribute("aria-hidden", "false");
      if(eventModalCloseBtn) eventModalCloseBtn.focus();
    });
  });

  updateSyncStatus();
  renderDispatchState();
  renderCalendar();
})();
</script>

<script>
(function(){if('serviceWorker'in navigator&&location.protocol.indexOf('http')===0){window.addEventListener('load',function(){navigator.serviceWorker.register('./sw.js?v=20260228-1').catch(function(){});});}})();
</script>

<nav class="tsms-bottom-nav" aria-label="ãƒœãƒˆãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <a href="report.html" data-tab="report"><span class="ico">ğŸ“</span><span>æ—¥å ±å…¥åŠ›</span></a>
  <a href="confirm.html" data-tab="confirm"><span class="ico">âœ…</span><span>å…¥åŠ›ç¢ºèª</span></a>
  <a href="detail.html" data-tab="detail"><span class="ico">ğŸ“Š</span><span>è©³ç´°ç¢ºèª</span></a>
  <a href="ops.html" data-tab="ops"><span class="ico">ğŸš•</span><span>å‡ºåº«/å¸°åº«</span></a>
  <button type="button" id="tsmsMoreBtn"><span class="ico">â‹¯</span><span>ãã®ä»–</span></button>
</nav>
<div class="tsms-more-bg" id="tsmsMoreBg"></div>
<div class="tsms-more-sheet" id="tsmsMoreSheet" aria-label="ãã®ä»–ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
  <a href="index.html">TOP</a>
  <a href="sales.html">æœˆé–“ç®¡ç†</a>
  <a href="settings.html">è¨­å®š</a>
</div>
<script>
(function(){
  var page=(location.pathname.split('/').pop()||'index.html').replace('.html','');
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    if(a.getAttribute('data-tab')===page) a.classList.add('active');
  });
  var iconMap={
    report:'<svg viewBox="0 0 24 24"><rect x="4" y="3" width="16" height="18" rx="2"/><path d="M8 8h8M8 12h8M8 16h5"/></svg>',
    confirm:'<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="m8 12 3 3 5-6"/></svg>',
    detail:'<svg viewBox="0 0 24 24"><path d="M4 19h16"/><rect x="6" y="10" width="3" height="6"/><rect x="11" y="7" width="3" height="9"/><rect x="16" y="5" width="3" height="11"/></svg>',
    ops:'<svg viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="8" rx="2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M6 8l2-3h8l2 3"/></svg>',
    more:'<svg viewBox="0 0 24 24"><circle cx="6" cy="7" r="1.5"/><circle cx="6" cy="12" r="1.5"/><circle cx="6" cy="17" r="1.5"/><path d="M10 7h10M10 12h10M10 17h10"/></svg>'
  };
  document.querySelectorAll('.tsms-bottom-nav [data-tab]').forEach(function(a){
    var k=a.getAttribute('data-tab');
    var ico=a.querySelector('.ico');
    if(ico && iconMap[k]) ico.innerHTML=iconMap[k];
  });
  var moreIco=document.querySelector('#tsmsMoreBtn .ico');
  if(moreIco) moreIco.innerHTML=iconMap.more;
  var btn=document.getElementById('tsmsMoreBtn');
  var bg=document.getElementById('tsmsMoreBg');
  var sheet=document.getElementById('tsmsMoreSheet');
  function closeMore(){ if(sheet) sheet.classList.remove('show'); if(bg) bg.classList.remove('show'); }
  if(btn&&bg&&sheet){
    btn.addEventListener('click',function(){sheet.classList.add('show');bg.classList.add('show');});
    bg.addEventListener('click',closeMore);
  }
  document.querySelectorAll('.tsms-bottom-nav a, .tsms-more-sheet a').forEach(function(a){
    a.addEventListener('click',closeMore);
  });
})();
</script>

<script src="./cache-version.js"></script>
</body>
</html>
